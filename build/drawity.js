/*!
 * Drawity JS - Pure JavaScript canvas-based paint engine
 * author Alexander Samsonov [alexandroppolus@yandex.ru]
 * version 0.1.0
 * licensed MIT
 */

!function(a,b){"object"==typeof exports&&"object"==typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):"object"==typeof exports?exports.drawity=b():a.drawity=b()}(this,function(){function a(a,b,c,d){"function"==typeof a&&(d=c,c=b,b=a,a=0),this._timer=null,this._once=d;var e=this;this._callback=function(){d&&(e._timer=null),b.call(c)},this._interval=0,this.setInterval(a)}var b=function(){function a(a,b){b=b||{};for(var c=0;c<m.length;++c)b[m[c]]=a[m[c]];return b.cmdKey=b.ctrlKey||b.metaKey,b}function b(a){if(l.offsetNode){var b=l.offsetNode.getBoundingClientRect();a.nodeX=a.clientX-Math.round(b.left),a.nodeY=a.clientY-Math.round(b.top)}}function c(a){return a?a.sort&&a.splice?a:[a]:null}function d(a,b){var c=a.options.distance;if(c&&"number"==typeof c&&c>0){if(b)return!1;if(Math.abs(k.start.pageX-k.current.pageX)+Math.abs(k.start.pageY-k.current.pageY)<c)return!1}return!a.events.dndStart||a.events.dndStart.call(a.options.ctx||a.events,k,b)!==!1}function e(c){if(1==c.which&&(g(c,!0),this._dndEnabled&&this._dndConfig)){k={target:c.target||c.srcElement,thisElement:this,data:{},start:a(c)};var e=this._dndConfig;if(l={started:!1,offsetNode:e.options.calcOffset?e.events.dndGetOffsetNode?e.events.dndGetOffsetNode.call(e.options.ctx||e.events,k):k.thisElement:null},b(k.start),k.current=k.start,e.events.dndMouseDown&&e.events.dndMouseDown.call(e.options.ctx||e.events,k,c)===!1)return k=null,void(l=null);k.old=k.start,l.started=d(e,!0),j(!0)}}function f(c){if(k){if(1!=c.which)return void g(c,!1);var e=k.thisElement._dndConfig;l.started&&(k.old=a(k.current,k.old==k.start?null:k.old)),k.current=a(c,k.current==k.start?null:k.current),b(k.current),(l.started||(l.started=d(e,!1),l.started))&&e.events.dndMove&&e.events.dndMove.call(e.options.ctx||e.events,k)}}function g(a,b){if(k){var c=k.thisElement._dndConfig;if(j(!1),c){var d=l.started?"dndStop":"dndSkip";c.events[d]&&c.events[d].call(c.options.ctx||c.events,k,b),c.events.dndMouseUp&&(k.started=l.started,c.events.dndMouseUp.call(c.options.ctx||c.events,k,b))}k=null,l=null}}function h(a){return g(a,!1)}function i(a){return a.preventDefault(),!1}function j(a){var b=a?"addEventListener":"removeEventListener";document[b]("mousemove",f,!1),document[b]("mouseup",h,!1),document[b]("dragstart",i,!1)}var k=null,l=null,m=["nodeX","nodeY","clientX","clientY","pageX","pageY","shiftKey","altKey","ctrlKey","metaKey"];return{create:function(a,b,d){a=c(a);for(var f=0;f<a.length;++f)a[f]._dndConfig||(a[f].addEventListener("mousedown",e,!1),a[f].addEventListener("dragstart",i,!1)),a[f]._dndConfig={events:b||{},options:d||{}},a[f]._dndEnabled=!0},destroy:function(a){a=c(a);for(var b=0;b<a.length;++b)a[b]._dndConfig&&(a[b]._dndConfig=null,a[b].removeEventListener("mousedown",e,!1),a[b].removeEventListener("dragstart",i,!1))},disable:function(a){a=c(a);for(var b=0;b<a.length;++b)a[b]._dndEnabled=!1},enable:function(a){a=c(a);for(var b=0;b<a.length;++b)a[b]._dndEnabled=!0}}}(),c=function(){function a(a){if(a&&a.length){this._EE_allowEvents={};for(var b=0;b<a.length;++b)this._EE_allowEvents[a[b]]=!0}this._selfHandlers&&"object"==typeof this._selfHandlers&&this.on("_selfHandlers",this)}function b(){}function c(a,b){this.emitResult=b}function d(a,b){return!a._EE_allowEvents||a._EE_allowEvents[b]===!0}function e(a,b,c,d){var e=null;if("string"==typeof c&&d&&"object"==typeof d?e=d[c]:"object"==typeof c&&(e=c),e&&"object"==typeof e){for(var f in e)e.hasOwnProperty(f)&&"function"==typeof e[f]&&a[b](f,e[f],d);return!0}return!1}return a.prototype={constructor:a,emit:function(a,e,f,g,h){if(a){if(f===!0)return g={},this.emit(a,e,c,g,!0),g.emitResult;if(g===!0&&(h=g,g=null),f="function"==typeof f?f:null,!a||!d(this,a))return f&&f.call(g,!1),!1;var i=this._EE_eventObservers&&this._EE_eventObservers[a];if(!i)return f&&f.call(g,!1),!1;var j=b;f&&(j=function(a){f&&(j=b,f.call(g,!0,a),f=g=null)});for(var k=!1,l=0;l<i.length;++l)k=i[l].callback.call(i[l].ctx||this,e,this,j,a)===!0||k;return k=k&&!h,!k&&f&&(f.call(g,!1),f=g=null),k&&!!f}},on:function(a,b,c){if(!a)return this;if(this._EE_eventObservers=this._EE_eventObservers||{},e(this,"on",a,b))return this;if(b&&d(this,a)){var f=this._EE_eventObservers[a]=this._EE_eventObservers[a]||[];f.push({callback:b,ctx:c||null})}return this},un:function(a,b,c){if(!a||!this._EE_eventObservers)return this._EE_eventObservers&&(this._EE_eventObservers=null),this;if(e(this,"un",a,b))return this;if(b){var d=this._EE_eventObservers[a];d&&(c=c||null,this._EE_eventObservers[a]=d.filter(function(a){return!(a.callback===b&&c==a.ctx)}))}else delete this._EE_eventObservers[a];return this}},a.mixin=function(b,c){return b&&"function"!=typeof b.emit?(b.emit=a.prototype.emit,b.on=a.prototype.on,b.un=a.prototype.un,a.call(b,c),b):b},a}(),d=function(){function a(a,b){this._maxSize=a||0,this._stack=[],this._batchCmd=null,this._batchDepth=0,this._stackPtr=0,this._eventEmitter=b,this.readOnly=!1}function b(a){if(a.__tail)for(var b=a.__tail.length-1;b>=0;--b)a.__tail[b].undo(),a.__tail[b].done=!1;a.undo(),a.done=!1}function c(a){if(a.redo(),a.done=!0,a.__tail)for(var b=0;b<a.__tail.length;++b)a.__tail[b].redo(),a.__tail[b].done=!0}function d(a,b){var c=!1,d=a.__tail?a.__tail[a.__tail.length-1]:a;d.groupId&&d.groupId===b.groupId&&"function"==typeof d.appendCommand&&(c=d.appendCommand(b)),c||(a.__tail||(a.__tail=[]),a.__tail.push(b)),b.redo(),b.done=!0}return a.prototype={constructor:a,undoLength:function(){return this._stackPtr},redoLength:function(){return this._stack.length-this._stackPtr},isEmpty:function(){return!this._stack.length},_emit:function(a,b){this._eventEmitter&&this._eventEmitter.emit(a,b)},_redoClear:function(a){this.redoLength()&&(this._emit("redoclear"),this._stack.length=this._stackPtr,a&&this._emit("change","redoclear"))},clear:function(a){return this._stack.length&&(a?this._redoClear(!0):(this._emit("clear"),this._stack=[],this._stackPtr=0,this._batchCmd=null,this._batchDepth=0,this._emit("change","clear"))),this},undo:function(){return!this.undoLength()||this._readOnly()?this:(this._emit("changing","undo"),this._stackPtr--,b(this._stack[this._stackPtr]),this._emit("change","undo"),this)},redo:function(){return!this.redoLength()||this._readOnly()?this:(this._emit("changing","redo"),this._redo("redo"))},_redo:function(a){return c(this._stack[this._stackPtr]),this._stackPtr++,this._emit("change",a),this},run:function(a,b){if(!a||this.readOnly)return this;this._emit("running"),this.redoLength()&&this._redoClear(!1),a.groupId=a.groupId||b;var c=this._batchCmd||!this._batchDepth&&a.groupId&&this._stackPtr&&this._stack[this._stackPtr-1].groupId===a.groupId&&this._stack[this._stackPtr-1];return c?d(c,a):(this._maxSize>0&&this._stack.length==this._maxSize&&(this._stack.shift(),this._stackPtr--),this._stack.push(a),this._batchDepth&&(this._batchCmd=a),this._redo("run")),this},beginBatch:function(){return this._batchDepth++,this},endBatch:function(a){return this._batchDepth&&(this._batchDepth=a?0:this._batchDepth-1,this._batchDepth||(this._batchCmd=null)),this},isBatchMode:function(){return!!this._batchDepth},_readOnly:function(){return this.readOnly||this._batchDepth}},a}();HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(a,b,c){for(var d=atob(this.toDataURL(b,c).split(",")[1]),e=d.length,f=new Uint8Array(e),g=0;g<e;g++)f[g]=d.charCodeAt(g);a(new Blob([f],{type:b||"image/png"}))}});var e=function(){function a(){if(!(this instanceof a)){var b=Object.create(a.prototype);return b.set.apply(b,arguments),b}this.set.apply(this,arguments)}var b=.3827;a.prototype={constructor:a,clone:function(b,c){if("boolean"==typeof b&&(c=b,b=null),b){if(b==this)return b;this.set.call(b,this)}else b=new a(this);return c&&(null!=this._origWidth?(b._origWidth=this._origWidth,b._origHeight=this._origHeight,b._origChanged=this._origChanged):this.clearProportions.call(b)),b},toString:function(){return"Rect("+this.left+", "+this.top+", "+this.right+", "+this.bottom+")"},width:function(a){return a?Math.abs(this.right-this.left):this.right-this.left},height:function(a){return a?Math.abs(this.bottom-this.top):this.bottom-this.top},size:function(a,b){return b=b||{},b.width=this.width(a),b.height=this.height(a),b},hasPoint:function(a,b){return a&&"object"==typeof a&&(b=a.y||a.top,a=a.x||a.left),a=a||0,b=b||0,this.left<=a&&this.right>a&&this.top<=b&&this.bottom>b},isIntersect:function(a){return!!a&&c.set(this).clip(a).minSize()>0},hasArea:function(){return a.hasArea(this)},hasSize:function(){return a.hasSize(this)},point:function(a){return a=e.getPointData(a),a?{x:a.left?this.left:a.right?this.right:Math.round((this.left+this.right)/2),y:a.top?this.top:a.bottom?this.bottom:Math.round((this.top+this.bottom)/2)}:{x:this.left,y:this.top}},margin:function(a,b){return b=b||[0,0,0,0],a?(b[0]=this.top-a.top,b[1]=a.right-this.right,b[2]=a.bottom-this.bottom,b[3]=this.left-a.left):b[0]=b[1]=b[2]=b[3]=0,b},minSize:function(a){return Math.min(this.width(a),this.height(a))},maxSize:function(a){return Math.max(this.width(a),this.height(a))},diagonal:function(){return a.diagonal(this.left,this.top,this.right,this.bottom)},angle:function(){return a.angle(this.left,this.top,this.right,this.bottom)},zero:function(){return this.left=this.top=this.right=this.bottom=0,this.clearProportions(),this},set:function(){var a=arguments;if(this.clearProportions(),1==a.length&&"object"==typeof a[0]){var b=a[0];b?(e.copyLT(this,b,"left","x"),e.copyLT(this,b,"top","y"),e.copyRB(this,b,"right","left","width"),e.copyRB(this,b,"bottom","top","height")):this.zero()}else if(4==a.length)this.left=a[0],this.top=a[1],this.right=a[2],this.bottom=a[3];else if(2==a.length||3==a.length)if("object"==typeof a[0]&&"object"==typeof a[1])e.copyLT(this,a[0],"left","x"),e.copyLT(this,a[0],"top","y"),e.copyRB(this,a[1],"right","left","width"),e.copyRB(this,a[1],"bottom","top","height");else{var c=3==a.length&&a[2];this.right=a[0],this.bottom=a[1],this.left=c?this.right:0,this.top=c?this.bottom:0}else this.zero();return this},moveTo:function(a,b){a&&"object"==typeof a&&(b=a.y||a.top,a=a.x||a.left);var c="number"==typeof a?a-this.left:0,d="number"==typeof b?b-this.top:0;return this.move(c,d)},normalize:function(){return e.swapSort(this,"left","right"),e.swapSort(this,"top","bottom"),this},change:function(a,b,c,d){return this.left+=a||0,this.right+=c||0,this.top+=b||0,this.bottom+=d||0,this},clearProportions:function(){return this._origWidth=null,this._origHeight=null,this._origChanged=!1,this},saveProportions:function(b,c){var d=typeof b;if(b&&"object"==d){if(b instanceof a)return null!=b._origWidth?(this._origWidth=b._origWidth,this._origHeight=b._origHeight):(this._origWidth=b.width(!0),this._origHeight=b.height(!0)),this._origChanged=!1,this;c=b.height,b=b.width}else if("number"==d)c="number"==typeof c?c:b;else{if(b!==!0&&null!=this._origWidth&&!this._origChanged)return this;b=this.width(),c=this.height()}return this._origWidth=Math.abs(b),this._origHeight=Math.abs(c),this._origChanged=!1,this},resize:function(c,d){var f=e.getPointData(c);if(!f||!d)return this;var g=d.resizeType||0;g>a.RT_R8&&(g=0);var h=e.getSize(this,f,d),i=e.getMinMaxSize(d.minSize,0),j=e.getMinMaxSize(d.maxSize,1e7);d.positiveOnly&&(f.width&&h.width<0&&(h.width=i.width),f.height&&h.height<0&&(h.height=i.height));var k=Math.abs(h.width),l=Math.abs(h.height);if(f.corner&&g){if(g<=a.RT_MAX){var m=1e-6,n=null==this._origWidth?this.width(!0):this._origWidth,o=null==this._origHeight?this.height(!0):this._origHeight;if(n<m&&o<m&&(n=o=1),n<m&&(k=0,l=Math.max(Math.min(l,j.height),i.height)),o<m&&(l=0,k=Math.max(Math.min(k,j.width),i.width)),n>=m&&o>=m){var p=n/o,q=e.mathFunc[g-1](l*p,k);l=e.mathFunc[g-1](k/p,l),k=q,k>j.width&&(k=j.width,l=k/p),l>j.height&&(l=j.height,k=l*p),k<i.width&&(k=i.width,l=k/p),l<i.height&&(l=i.height,k=l*p),k=Math.round(k),l=Math.round(l)}}if(g===a.RT_R8)if(k<l*b)k=0,l=Math.max(Math.min(l,j.height),i.height);else if(l<k*b)l=0,k=Math.max(Math.min(k,j.width),i.width);else{var r=Math.round((l+k)/2);r=Math.max(Math.min(r,j.width,j.height),i.width,i.height),l=k=r}}else k=Math.max(Math.min(k,j.width),i.width),l=Math.max(Math.min(l,j.height),i.height);return h.width=h.width<0?-k:k,h.height=h.height<0?-l:l,null!=this._origWidth&&(this._origChanged=(g<a.RT_MIN||g>a.RT_MAX||!f.corner)&&(f.width&&h.width!=this.width()||f.height&&h.height!=this.height())),this.setSize(f,h)},rotate90:function(a){var b=this.width(),c=this.height();if(b===c)return this;if(a){var d=b/2,e=c/2,f=this.left+d,g=this.top+e;this.left=Math.round(f-e),this.top=Math.round(g-d)}if(this.right=this.left+c,this.bottom=this.top+b,null!=this._origWidth){var h=this._origWidth;this._origWidth=this._origHeight,this._origHeight=h}return this},setSize:function(a,b){var c=e.getPointData(a);return c&&(c.left&&(this.left=this.right-b.width),c.top&&(this.top=this.bottom-b.height),c.right&&(this.right=this.left+b.width),c.bottom&&(this.bottom=this.top+b.height)),this},apply:function(a){return this.left=a(this.left),this.top=a(this.top),this.right=a(this.right),this.bottom=a(this.left),this},move:function(a,b){return this.change(a,b,a,b)},expand:function(a,b){return a=a||0,"number"!=typeof b&&(b=a),(a||b)&&this.clearProportions(),this.change(-a,-b,a,b)},clip:function(a){return a&&(this.left=Math.min(Math.max(a.left,this.left),a.right),this.top=Math.min(Math.max(a.top,this.top),a.bottom),this.right=Math.min(Math.max(a.left,this.right),a.right),this.bottom=Math.min(Math.max(a.top,this.bottom),a.bottom),this.clearProportions()),this},union:function(a){return a&&(this.left=Math.min(this.left,a.left),this.top=Math.min(this.top,a.top),this.right=Math.max(this.right,a.right),this.bottom=Math.max(this.bottom,a.bottom),this.clearProportions()),this},unionWithPoint:function(a,b,c){a&&"object"==typeof a&&(c=b,b=null==a.y?a.top:a.y,a=null==a.x?a.left:a.x);var d=c?1:0;return"number"==typeof a&&(this.left=Math.min(this.left,a),this.right=Math.max(this.right,a+d)),"number"==typeof b&&(this.top=Math.min(this.top,b),this.bottom=Math.max(this.bottom,b+d)),this},unionWithPoints:function(a,b){for(var c=0;c<a.length;c+=2)this.unionWithPoint(a[c],a[c+1],b);return this},fromPoints:function(a,b){return a&&a.length?this.set(a[0],a[1],!0).unionWithPoints(a,b):this.zero()},into:function(a,b){if(a){var c=e.intoDelta(this.left,this.right,a.left,a.right,b,/L/i,/R/i),d=e.intoDelta(this.top,this.bottom,a.top,a.bottom,b,/T/i,/B/i);this.move(c,d)}return this}};var c=new a;a.RT_MIN=1,a.RT_AVG=2,a.RT_MAX=3,a.RT_R8=4,a.RT_R12=5,a.diagonal=function(a,b,c,d){var e=c-a,f=d-b;return e&&f?Math.sqrt(e*e+f*f):Math.abs(e||f)},a.angle=function(a,b,c,d){var e=c-a,f=d-b,g=Math.PI;if(!f||!e)return e<0?g:f<0?3*g/2:f?g/2:0;var h=Math.atan(Math.abs(f/e));return e>0?f>0?h:2*g-h:f>0?g-h:g+h},a.isIntersect=function(b,c){return!!b&&a.prototype.call(b,c)},a.hasArea=function(a){return a.right>a.left&&a.bottom>a.top},a.hasSize=function(a){return a.right>a.left||a.bottom>a.top},a.get=function(b){return b&&b instanceof a?b:new a(b)},a.equal=function(a,b){return a&&b?a.left==b.left&&a.top==b.top&&a.right==b.right&&a.bottom==b.bottom:!a==!b};var d={},e={mathFunc:[function(a,b){return Math.min(a,b)},function(a,b){return(a+b)/2},function(a,b){return Math.max(a,b)}],getMinMaxSize:function(a,b){return a&&"object"==typeof a?a:"number"==typeof a?{width:a,height:a}:{width:b,height:b}},getSize:function(a,b,c){var d=null;if("number"==typeof c.width&&"number"==typeof c.height?d={width:c.width,height:c.height}:"number"==typeof c.size?d={width:c.size,height:c.size}:c.size&&"object"==typeof c.size&&(d={width:c.size.width,height:c.size.height}),d)return d.width=b.width?d.width:a.width(),d.height=b.height?d.height:a.height(),d;var e=null;if("number"==typeof c.x&&"number"==typeof c.y?e=c:c.point&&"object"==typeof c.point&&(e=c.point),e)return{width:b.right?e.x-a.left:b.left?a.right-e.x:a.width(),height:b.bottom?e.y-a.top:b.top?a.bottom-e.y:a.height()};var f=c.deltaX||0,g=c.deltaY||0;return{width:a.width()+(b.right?f:b.left?-f:0),height:a.height()+(b.bottom?g:b.top?-g:0)}},getPointData:function(a){if(!a)return null;if(d===a)return d;var b="c"===a;return d.right=!b&&/r/i.test(a)?1:0,d.bottom=!b&&/b/i.test(a)?1:0,d.left=b||d.right||!/l/i.test(a)?0:1,d.top=b||d.bottom||!/t/i.test(a)?0:1,d.center=b,d.width=d.left||d.right||0,d.height=d.top||d.bottom||0,d.center||d.width||d.height?(d.corner=d.width&&d.height,d):null},swapSort:function(a,b,c){if(a[b]>a[c]){var d=a[b];a[b]=a[c],a[c]=d}},copyLT:function(a,b,c,d){return"number"==typeof b[c]?void(a[c]=b[c]):"number"==typeof b[d]?void(a[c]=b[d]):void(a[c]=0)},copyRB:function(a,b,c,d,e){return"number"==typeof b[c]?void(a[c]=b[c]):"number"==typeof b[e]?void(a[c]=a[d]+b[e]):void(a[c]=a[d])},intoDelta:function(a,b,c,d,e,f,g){return a>=c&&b<=d?0:a<c&&b>d?f.test(e)?c-a:g.test(e)?d-b:0:a<c?Math.min(c-a,d-b):b>d?Math.max(c-a,d-b):0}};return a}();a.prototype={constructor:a,destroy:function(){this.stop(),this._callback=null},setInterval:function(a){if("number"==typeof a&&a>=0&&this._interval!==a){this._interval=a;var b=this._timer;this.stop(),b&&this.start()}return this},start:function(){return!this._timer&&this._interval>=1&&(this._timer=this._once?setTimeout(this._callback,this._interval):setInterval(this._callback,this._interval)),this},started:function(){return!!this._timer},stop:function(){return this._timer&&(this._once?clearTimeout(this._timer):clearInterval(this._timer),this._timer=null),this},timeout:function(){return this._timer&&(this._once?(clearTimeout(this._timer),this._callback()):this.stop()),this}};var f=function(){function a(a,b,c){b[c]=function(){var b=a[c].apply(a,arguments);return b===a?this:b}}var b={width:1/0,height:1/0},c={width:0,height:0},d={copy:function(){var a=arguments;if(!a.length||1==a.length&&!a[0])return null;for(var b=a.length>1?a[0]||{}:{},c=a.length>1?1:0;c<a.length;++c)if(a[c]){src=a[c];for(var d in src)src.hasOwnProperty(d)&&(b[d]=src[d])}return b},createClass:function(a,b,c){"function"!=typeof a&&(a=Object),"function"==typeof b&&(b=b(a.prototype,a));var e=b&&b.hasOwnProperty("constructor")&&"function"==typeof b.constructor?b.constructor:function(){};return e.prototype=Object.create(a.prototype),d.copy(e.prototype,b),e.prototype.constructor=e,d.copy(e,c)},bind:function(a,b){return function(){return a.apply(b,arguments)}},bindAll:function(a,b){var c={};for(var d in a)a.hasOwnProperty(d)&&"function"==typeof a[d]&&(c[d]=this.bind(a[d],b));return c},between:function(a,b,c){return Math.max(a||-(1/0),Math.min(b,c||1/0))},sizeBetween:function(a,d,e){return a=a||c,e=e||b,{width:this.between(a.width,d.width,e.width),height:this.between(a.height,d.height,e.height)}},applyTemplate:function(a,b){return a&&a.replace(/\$\{([a-z0-9_]+)\}/g,function(a,c){return b[c]||a})},checkNumber:function(a,b,c,e){return null==e?function(e){return null!=e&&d.checkNumber(a,b,c,e)}:"number"==typeof e&&(!c||Math.round(e)===e)&&(null==a||a<=e)&&(null==b||e<=b)},getOrigin:function(a){var b=/^([a-z]+:\/\/)([^\/]+@)?([^\/]+)/i.exec(a);return b?b[1]+b[3]:null},isCrossOrigin:function(a,b){if(!/^(https?|ftp):\/\//.test(b))return!1;var c=this.getOrigin(a),d=this.getOrigin(b);return c&&d&&c!=d},property:function(a,b,c){return function(d,e){if(void 0!==d){var f=this[a];return c&&c.call(this,d,f,e)===!1?this:(d!==f&&(this[a]=d,b&&b.call(this,d,f,e)),this)}return this[a]}},proxy:function(b,c){for(var d=Object.create(null),e=0;e<c.length;++e)a(b,d,c[e]);return d}};return d}(),g=g||{};g.color=function(){function a(a){return a<16?"0"+a.toString(16):a.toString(16)}function b(a){var b=parseInt(a,10),c=a.charCodeAt(a.length-1)===j;return c&&b>100||b>255?null:c?Math.round(b/100*255):b}function c(a,b){a=b?a.substr(b):a;var c=parseFloat(a);return!isNaN(c)&&c>=0&&c<=1?Math.round(255*c):null}function d(a,b){var c,d,e;return 7===a.length?(c=a.substr(1,2),d=a.substr(3,2),e=a.substr(5,2)):(c=a.substr(1,1),d=a.substr(2,1),e=a.substr(3,1),c+=c,d+=d,e+=e),b[0]=parseInt(c,16),b[1]=parseInt(d,16),b[2]=parseInt(e,16),b[3]=255,b}var e={extactAlpha:function(a){var b=f.exec(a);return b?{color:b[1]+b[2]+")",alpha:parseFloat(b[3])}:{color:a,alpha:1}},addAlpha:function(a,b){var c=e.getRGBA(a);return c[3]=b,e.colorStr(c)},checkColor:function(a){return!!e.getRGBA(a,l)},createColor:function(){return new k(4)},getRGBA:function(a,e){if(!a||"string"!=typeof a)return null;if(a=a.replace(/\s+/g,"").toLowerCase(),m.hasOwnProperty(a))return e=e||new k(4),d(m[a],e);if(h.test(a))return e=e||new k(4),d(a,e);var f=i.exec(a);if(f){if(!f[2]!=!f[6])return null;var g=b(f[3]),j=b(f[4]),l=b(f[5]),n=f[2]?c(f[6],1):255;return null===g||null===j||null===l||null===n?null:(e=e||new k(4),e[0]=g,e[1]=j,e[2]=l,e[3]=n,e)}return null},isEqvRGB:function(a,b){return 0===a[3]&&0===b[3]||a[3]>0&&b[3]>0&&a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]},isEqvRGBA:function(a,b){return 0===a[3]&&0===b[3]||a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]&&a[3]===b[3]},colorStr:function(b){return b[3]>254?"#"+a(b[0])+a(b[1])+a(b[2]):"rgba("+b[0].toString()+","+b[1].toString()+","+b[2].toString()+","+(b[3]/255).toFixed(4)+")"},format:function(a){if(!a||g.test(a))return a&&a.toLowerCase();var b=e.getRGBA(a,l);return b&&e.colorStr(b)},getSafeColors:function(){for(var b=[],c=0;c<256;c+=51)for(var d=0;d<256;d+=51)for(var e=0;e<256;e+=51)b.push("#"+a(c)+a(d)+a(e));return b}},f=/^\s*(rgb|hsl)a\s*(\([^,]+,[^,]+,[^,]+),\s*([^\)]+)\)\s*$/,g=/^#[0-9a-fA-F]{6}$/,h=/^#(?:[0-9a-fA-F]{3}){1,2}$/,i=/^(rgb)(a?)\(([0-9]{1,3}%?),([0-9]{1,3}%?),([0-9]{1,3}%?)(,[0-9\.]+)?\)$/,j="%".charCodeAt(0),k="function"==typeof Uint8Array?Uint8Array:Array,l=new k(4),m={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",feldspar:"#d19275",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslateblue:"#8470ff",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",violetred:"#d02090",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};return e}();var g=g||{};g.copyImage=function(a,b,c){var d=b.getContext("2d"),e=a.naturalWidth||a.width,f=a.naturalHeight||a.height;if(!e||!f)return b;var g=c?b.width:e,h=c?b.height:f;return d.drawImage(a,0,0,e,f,0,0,g,h),b},g.drawImage=function(a,b,c,d){var e=a.getContext("2d"),f=b.right-b.left,g=b.bottom-b.top;c&&e.clearRect(b.left,b.top,f,g),d&&e.drawImage(d,0,0,f,g,b.left,b.top,f,g)},g.resetGlobals=function(a){a.globalCompositeOperation="source-over"},g.setOptions=function(a,b){if(b)for(var c in b)b.hasOwnProperty(c)&&null!=b[c]&&(a[c]=b[c])},g.setCtxShapeOptions=function(a,b){a.strokeStyle=b.color,a.lineWidth=b.lineWidth,a.lineCap=b.lineCap,a.lineJoin=b.lineJoin,a.fillStyle=b.fillColor};var g=g||{};g.imageData={copy:function(a,b){var c=Math.max(a.data.length,b.data.length);a=a.data,b=b.data;for(var d=0;d<c;++d)b[d]=a[d]},fillRect:function(a,b,c){var d=c?Math.max(c.left,0):0,e=c?Math.max(c.top,0):0,f=c?Math.min(c.right,a.width):a.width,g=c?Math.min(c.bottom,a.height):a.height,h=a.width;a=a.data;for(var i=e;i<g;++i)for(var j=4*(h*i+f),k=j-4*(f-d);k<j;++k)data[k]=b[0],data[++k]=b[1],data[++k]=b[2],data[++k]=b[3]},setPixelColor:function(a,b,c,d,e){var f=4*(c*a.width+b),g=a.data;g[f]=d[0],g[f+1]=d[1],g[f+2]=d[2],e&&(g[f+3]=d[3])}},g.ImageData=function(){var a=f.createClass(null,{constructor:function(a,b,c){if(a.data&&a.width&&a.height)this._imgData=a;else{b&&"boolean"!=typeof b||(c=b,b={left:0,top:0,right:a.canvas.width,bottom:a.canvas.height});var d=b.right-b.left,e=b.bottom-b.top;this._imgData=c?a.createImageData(d,e):a.getImageData(b.left,b.top,d,e)}this._rect={left:0,top:0,right:this._imgData.width,bottom:this._imgData.height}},getData:function(){return this._imgData},width:function(){return this._rect.right},height:function(){return this._rect.bottom},getPixelColor:function(a,b,c){c=c||g.color.createColor();var d=4*(b*this._imgData.width+a),e=this._imgData.data;return c[0]=e[d],c[1]=e[d+1],c[2]=e[d+2],c[3]=e[d+3],c},setPixelColor:function(a,b,c,d){var e=4*(b*this._imgData.width+a),f=this._imgData.data;f[e]=c[0],f[e+1]=c[1],f[e+2]=c[2],d&&(f[e+3]=c[3])},floodFill:function(a,b,c,d,e){function f(a,b){for(var c=a;c>l&&k(p,v.getPixelColor(c-1,b,q));)c--;return c}function h(a,b,d){var f;for(f=a;f<=b||f<n&&k(p,v.getPixelColor(f,d,q));++f)v.setPixelColor(f,d,c,e);return f}function i(a,b,c){for(;a<b;)k(p,v.getPixelColor(a,c,q))?a=j(a,c):a++}function j(a,b){var c=f(a,b),d=h(c,a,b);return b>m&&i(c,d,b-1),b<o-1&&i(c,d,b+1),c<r&&(r=c),d>t&&(t=d),b<s&&(s=b),b>u&&(u=b),d}var k=d?g.color.isEqvRGBA:g.color.isEqvRGB,l=0,m=0,n=this._imgData.width,o=this._imgData.height,p=this.getPixelColor(a,b),q=g.color.createColor();if(a<0||b<0||a>=n||b>=o)return null;var r=a,s=b,t=a+1,u=b;if(k(c,p))return null;if(d&&!e&&g.color.isEqvRGB(c,p))return null;var v=this;return j(a,b),{left:r,top:s,right:Math.min(t,n),bottom:Math.min(u+1,o)}},slice:function(b,c){c=c||this._rect;var d=new a(b,c,(!0));return d.copyFrom(this,c)},copyFrom:function(a,b,c,d){b=b||a._rect,c=c||0,d=d||0;for(var e=b.left-c,f=b.top-d,h=b.left+Math.min(this.width()-c,b.right-b.left),i=b.top+Math.min(this.height()-d,b.bottom-b.top),j=g.color.createColor(),k=b.left;k<h;++k)for(var l=b.top;l<i;++l)a.getPixelColor(k,l,j),this.setPixelColor(k-e,l-f,j,!0);return this},fillRect:function(a,b){b=b||this._rect;for(var c=b.left;c<b.right;++c)for(var d=b.top;d<b.bottom;++d)this.setPixelColor(c,d,a,!0)},isImageDataWrapper:!0});return a}();var g=g||{};g.patterns=function(){function a(a,c,d,f){this._type=a,this._color=c,this._offsetX=d,this._offsetY=f;var g=e[a];this.width=g.pixels[0].length,this.height=g.pixels.length,b||(b=document.createElement("canvas")),b.width=this.width,b.height=this.height;var h=b.getContext("2d");this._drawPattern(g,h),this.url=b.toDataURL("image/png"),this.pattern=h.createPattern(b,"repeat")}var b,c=16,d=[],e={dots:{pixels:[[0,0,0],[0,1,0],[0,0,0]]},dotsd:{pixels:[[0,0,0,0],[0,1,0,0],[0,0,0,0],[0,0,0,0]]},dotsb:{pixels:[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]]},dotsbd:{pixels:[[0,0,0,0,0],[0,1,1,0,0],[0,1,1,0,0],[0,0,0,0,0],[0,0,0,0,0]]},lines0:{pixels:[[0],[1],[0]]},lines0d:{pixels:[[0],[1],[0],[0]]},lines0b:{pixels:[[0],[1],[1],[0]]},lines0bd:{pixels:[[0],[1],[1],[0],[0]]},lines45:{pixels:[[1,0,0,0,0],[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0],[0,0,0,0,1]]},lines45d:{pixels:[[1,0,0,0,0,0],[0,1,0,0,0,0],[0,0,1,0,0,0],[0,0,0,1,0,0],[0,0,0,0,1,0],[0,0,0,0,0,1]]},lines45b:{pixels:[[1,1,0,0,0,0],[0,1,1,0,0,0],[0,0,1,1,0,0],[0,0,0,1,1,0],[0,0,0,0,1,1],[1,0,0,0,0,1]]},lines45bd:{pixels:[[1,1,0,0,0,0,0],[0,1,1,0,0,0,0],[0,0,1,1,0,0,0],[0,0,0,1,1,0,0],[0,0,0,0,1,1,0],[0,0,0,0,0,1,1],[1,0,0,0,0,0,1]]},lines90:{pixels:[[0,1,0]]},lines90d:{pixels:[[0,1,0,0]]},lines90b:{pixels:[[0,1,1,0]]},lines90bd:{pixels:[[0,1,1,0,0]]},lines135:{pixels:[[0,0,0,0,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,0,0,0,0]]},lines135d:{pixels:[[0,0,0,0,0,1],[0,0,0,0,1,0],[0,0,0,1,0,0],[0,0,1,0,0,0],[0,1,0,0,0,0],[1,0,0,0,0,0]]},lines135b:{pixels:[[0,0,0,0,1,1],[0,0,0,1,1,0],[0,0,1,1,0,0],[0,1,1,0,0,0],[1,1,0,0,0,0],[1,0,0,0,0,1]]},lines135bd:{pixels:[[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,1,1,0,0,0],[0,1,1,0,0,0,0],[1,1,0,0,0,0,0],[1,0,0,0,0,0,1]]}},f={getAllTypes:function(a){var b=Object.keys(e);return a&&b.unshift(""),b},checkName:function(a){return"string"==typeof a&&(""===a||e.hasOwnProperty(a))},getPattern:function(a,b,c,d){var e=this._getPattern(a,b,c,d);return e?e.pattern:null},getPatternUrl:function(a,b,c,d){var e=this._getPattern(a,b,c,d);return e?e.url:null},_getPattern:function(b,f,g,h){if(!b||!f||!e.hasOwnProperty(b))return null;var i=e[b],j=i.pixels[0].length,k=i.pixels.length;g=(g||0)%j,h=(h||0)%k,g<0&&(g=j+g),h<0&&(h=k+h);for(var l=0;l<d.length;++l)if(d[l].isMatch(b,f,g,h))return d[l];var m=new a(b,f,g,h);return d.push(m),d.length>c&&d.shift(),m}},h=[0,0,0,0];return a.prototype._drawPattern=function(a,b){a._imageData||(a._imageData=b.createImageData(this.width,this.height));for(var c=g.color.getRGBA(this._color),d=0;d<this.height;++d)for(var e=this.y(d),f=0;f<this.width;++f){var i=this.x(f);g.imageData.setPixelColor(a._imageData,i,e,a.pixels[d][f]?c:h,!0)}b.putImageData(a._imageData,0,0)},a.prototype.isMatch=function(a,b,c,d){return this._type===a&&this._color===b&&this._offsetX===c&&this._offsetY===d},a.prototype.x=function(a){return(this.width+a-this._offsetX)%this.width},a.prototype.y=function(a){return(this.height+a-this._offsetY)%this.height},f}();var g=g||{};g.rotate=function(){var a={x:function(a,b){return[-1,0,0,1,a,0]},y:function(a,b){return[1,0,0,-1,0,b]},90:function(a,b){return[0,1,-1,0,b,0]},180:function(a,b){return[-1,0,0,-1,a,b]},270:function(a,b){return[0,-1,1,0,0,a]}};return{rotateOrto:function(b,c,d){var e=a[String(d).toLowerCase()];if(e){c.save();var f=b.width,g=b.height;c.setTransform.apply(c,e(f,g)),c.drawImage(b,0,0,f,g,0,0,f,g),c.restore()}}}}();var g=g||{};g.shapes=function(){var a={squarePenLine:function(a,b,c,d,e,f,g){var h,i;return b===d||c===e?(h=Math.min(b,d),i=Math.min(c,e),void a.rect(h-f,i-f,Math.max(b,d)-h+f+g,Math.max(c,e)-i+f+g)):(d<b&&(h=b,b=d,d=h,i=c,c=e,e=i),a.moveTo(b-f,c-f),e>c?a.lineTo(b+g,c-f):a.lineTo(d-f,e-f),a.lineTo(d+g,e-f),a.lineTo(d+g,e+g),e>c?a.lineTo(d-f,e+g):a.lineTo(b+g,c+g),void a.lineTo(b-f,c+g))},useFillPath:function(a,b){return"round"!==b&&a>2},_drawStrokePath:function(a,b,c){var d=c%2?.5:0;if(b.length<4)return a.arc(b[0]+d,b[1]+d,c/2,0,2*Math.PI),a.fillStyle=a.strokeStyle,void a.fill();a.moveTo(b[0]+d,b[1]+d);for(var e=3;e<b.length;e+=2)a.lineTo(b[e-1]+d,b[e]+d);a.stroke()},_drawFillPath:function(a,b,c){var d=Math.floor(c/2+1e-6),e=Math.ceil(c/2-1e-6);
if(b.length<4)return this.squarePenLine(a,b[0],b[1],b[0],b[1],d,e),void a.fill();for(var f=3;f<b.length;f+=2)this.squarePenLine(a,b[f-3],b[f-2],b[f-1],b[f],d,e);a.fill()},drawPath:function(a,b,c,d){if(b&&!(b.length<2)){c=c||1;var e=this.useFillPath(c,d);a.beginPath(),e?this._drawFillPath(a,b,c):this._drawStrokePath(a,b,c)}},_getColor:function(a,b){return"erase"===b?"#000000":a},isEraser:function(a){return"erase"===a||"parterase"===a},_setGCO:function(a,b){this.isEraser(b)&&(a.globalCompositeOperation="destination-out")},getDrawStyle:function(a,b,c){return a.drawPattern?g.patterns.getPattern(a.drawPattern,b,c?c.left:0,c?c.top:0):b},makePenOptions:function(a,b,c,d){var e={},f=this._getColor(b||a.color,d&&"erase");f=this.getDrawStyle(a,f,c);var g=a.lineWidth||1;e.fillStyle=f;var h=this.useFillPath(g,a.penForm);return h||(e.strokeStyle=f,e.lineWidth=g,e.lineCap=g>1?"round":"square",e.lineJoin="round"),this._setGCO(e,d&&"erase"),e},compressPath:function(a){if(!a||a.length<6)return a;for(var b=3,c=a[0],d=a[1],e=a[2],f=a[3],g=5;g<a.length;g+=2){var h=a[g-1],i=a[g],j=c===e&&e===h&&d>=f==f>=i||d===f&&f===i&&c>=e==e>=h||i-f===f-d&&h-e===e-c;j?(e=a[b-1]=h,f=a[b]=i):(c=e,d=f,e=a[g-1],f=a[g],b+=2,b+2<=g&&(a[b-1]=a[g-1],a[b]=a[g]))}return a.length=b+1,a},drawLine:function(a,b){var c=a.lineWidth%2?.5:0;a.beginPath(),a.moveTo(b.left+c,b.top+c),a.lineTo(b.right+c,b.bottom+c),a.stroke()},drawBezier:function(a,b){var c=a.lineWidth%2?.5:0;a.beginPath(),a.moveTo(b[0]+c,b[1]+c),4==b.length&&a.lineTo(b[2]+c,b[3]+c),6==b.length&&a.quadraticCurveTo(b[2]+c,b[3]+c,b[4]+c,b[5]+c),8==b.length&&a.bezierCurveTo(b[2]+c,b[3]+c,b[4]+c,b[5]+c,b[6]+c,b[7]+c),a.stroke()},makeLineOptions:function(a,b,c){var d={},e=b?this._getColor(a.color,a.drawLine):a.color;e=this.getDrawStyle(a,e,c);var f=a.lineWidth||1;return d.strokeStyle=e,d.lineWidth=f,d.lineCap=f>1?a.lineCap||"round":"square",b&&this._setGCO(d,a.drawLine),d},makeShapeOptions:function(a,b,c){var d={},e=a.lineWidth||1;d.strokeStyle=a.color;var f=this._getColor(a.fillColor,a.drawShape);return f=this.getDrawStyle(a,f,c),d.fillStyle=f,d.lineWidth=e,e>1&&"round"===a.lineJoin?(d.lineCap="round",d.lineJoin="round"):(d.lineCap="square",d.lineJoin="miter"),this._setGCO(d,a.drawShape),d},drawShape:function(a,c,d,e,f){var g="stroke"===e||"both"===e?a.lineWidth:0,h="stroke"!==e;(h||g)&&"function"==typeof b[c]&&b[c](a,d,h,g,f)}},b={rect:function(a,b,c,d){if(!d)return void a.fillRect(b.left,b.top,b.right-b.left+1,b.bottom-b.top+1);if(c){var e=Math.ceil(d/2),f=b.right-b.left-d,g=b.bottom-b.top-d;f>0&&g>0&&a.fillRect(b.left+e,b.top+e,f,g)}var h=d%2?.5:0;a.beginPath(),a.moveTo(b.left+h,b.top+h),a.lineTo(b.right+h,b.top+h),a.lineTo(b.right+h,b.bottom+h),a.lineTo(b.left+h,b.bottom+h),a.lineTo(b.left+h,b.top+h),a.stroke()},_roundrectPath:function(a,b,c,d,e,f){a.beginPath(),a.moveTo(b+f,c),a.arcTo(d,c,d,e,f),a.arcTo(d,e,b,e,f),a.arcTo(b,e,b,c,f),a.arcTo(b,c,d,c,f)},roundrect:function(a,b,c,d,e){var f=e.rectRadius||1;if(f=Math.min(f,(b.right-b.left)/2,(b.bottom-b.top)/2),!d)return this._roundrectPath(a,b.left,b.top,b.right+1,b.bottom+1,f),void a.fill();if(c){var g=Math.ceil(d/2),h=d-g,i=f-a.lineWidth/2,j=b.right-b.left-d,k=b.bottom-b.top-d;j>0&&k>0&&(i>0?(this._roundrectPath(a,b.left+g,b.top+g,b.right-h,b.bottom-h,i),a.fill()):a.fillRect(b.left+g,b.top+g,j,k))}var l=d%2?.5:0;this._roundrectPath(a,b.left+l,b.top+l,b.right+l,b.bottom+l,f),a.stroke()},_setEllipsTransform:function(a,b,c,d,e,f,g){a.translate(d.left+b,d.top+c),f>g?a.scale(1,g/f):a.scale(f/g,1)},ellipse:function(a,b,c,d){var e=b.right-b.left+1,f=b.bottom-b.top+1,g=e/2,h=f/2,i=d%2?.5:0,j=e>f?g:h;if(a.save(),this._setEllipsTransform(a,g,h,b,j,e,f),d){if(c&&e>d&&f>d){a.beginPath(),a.arc(0,0,j,0,2*Math.PI),a.restore(),a.fill(),a.save(),this._setEllipsTransform(a,g,h,b,j,e,f)}a.beginPath(),a.arc(0,0,j+i,0,2*Math.PI),a.restore(),a.stroke()}else a.beginPath(),a.arc(0,0,j,0,2*Math.PI),a.restore(),a.fill()}};return a}();var g=g||{};g.text=function(){return{makeFont:function(a){return(a.fontBold?"bold ":"")+(a.fontItalic?"italic ":"")+a.fontSize+"px "+a.fontFamily},makeTextOptions:function(a){var b={};return b.fillStyle=a.color,b.font=this.makeFont(a),b},drawText:function(a,b,c,d){if(b){a.textBaseline="top";for(var e=c.y,f=0;f<b.length;++f)a.fillText(b[f],c.x,e),e+=d}},checkFont:function(a){return!0}}}();var h=function(){var a={getImage:function(a,b,c,d){return a?("function"==typeof b&&(d=c,c=b,b=null),void("string"==typeof a?this.getImageFromURL(a,b,c,d):this.getImageFromBlob(a,c,d))):void c.call(d,{img:null,error:"noParam"})},getImageFromBlob:function(a,b,c){if(!(a&&"undefined"!=typeof Blob&&a instanceof Blob))return void b.call(c,{img:null,error:"noBlob"});var d=a.name,e=this.getImageFromURL;if("undefined"!=typeof URL&&URL&&URL.createObjectURL){var f=URL.createObjectURL(a);e(f,null,function(e){URL.revokeObjectURL(f),e.fileName=d,b.call(c,e,a)})}else if("function"==typeof FileReader){var g=new FileReader;g.onload=function(){e(this.result,null,function(e){e.fileName=d,b.call(c,e,a)})},g.readAsDataURL(a)}},getImageFromURL:function(a,b,c,d){var e=new Image;if(b&&f.isCrossOrigin(location.href,a)){var g=!1;if(b.getProxyUrl&&(a=b.getProxyUrl.call(b.ctx||b,a),g=!f.isCrossOrigin(location.href,a)),!g){if(void 0===e.crossOrigin)return void c.call(d,{img:null,error:"crossOrigin"},a);e.crossOrigin=b.useCredentials?"use-credentials":"anonymous"}}e.onload=function(){c.call(d,{img:e,error:null},a)},e.onerror=function(){c.call(d,{img:null,error:"onError"},a)},e.src=a},getImageFromEvent:function(b,d,e,f){var g=b.target;return"paste"==b.type?void c(b.clipboardData,b.type,function(c,h,i){return(c||h||i)&&(b.stopPropagation(),b.preventDefault()),c?void a.getImageFromBlob(c,d,e):h?void d.call(e,{url:h,img:null,error:null}):i?void d.call(e,{url:null,img:i,error:null}):(f&&f.call(e),void setTimeout(function(){var a=g.getElementsByTagName("img")[0];g.parentNode&&g.parentNode.removeChild(g),a?(a.parentNode.removeChild(a),a.complete?d.call(e,{img:a,error:null}):a.onload=function(){d.call(e,{img:a,error:null})}):d.call(e,{img:null,error:"noImage"})},200))}):"drop"==b.type?void c(b.dataTransfer,b.type,function(b,c,f){return b?void a.getImageFromBlob(b,d,e):c?void d.call(e,{url:c,img:null,error:null}):f?void d.call(e,{url:null,img:f,error:null}):void 0}):void d.call(e,{img:null,name:null,event:b.type,error:"notImplemented"})}},b=/^image\/(?:bmp|ico|png|gif|jpe?g)$/,c=function(a,c,e){if(!a)return void e(null,null,null);var f,g;if(a.files&&a.files.length)for(g=0;g<a.files.length;++g)if(f=a.files[g],b.test(f.type))return void e(f,null,null);if(a.items)for(g=0;g<a.items.length;++g){var h=a.items[g];if("file"===h.kind&&b.test(h.type)&&(f=h.getAsFile()))return void e(f,null,null)}d(a,c,e)},d=function(b,c,d){var e,f="paste"===c?"text/plain":"text/html";try{e=b.getData(f)}catch(g){}var i=a.customImageClipboard.get(e);if(i)return void d(null,null,i);var j=i===!1?h(f,e):null;d(null,j,null)},e=/^<img\s[^<>]*\bsrc\s*=\s*['"]((?:http|data:image)[^'"]+)/,g=/^data:image\/(?:bmp|ico|png|gif|jpe?g);base64,.{20}/,h=function(a,b){if(a&&b&&b.length<8e3){if("text/html"===a){var c=e.exec(b);return c?c[1]:null}if("text/plain"===a)return g.test(b)?b:null}return null},i="cicb:jscp-img-51ebce89b51840b490e5469b5eb59c41#";return a.customImageClipboard={_lastUrl:"",_canvas:null,_tryBase64:function(a){if(a.width*a.height>1e4)return null;var b=a.toDataURL("image/png");return b.length<8e3?b:null},put:function(a){if(this._canvas=null,this._lastUrl="",a){var b=this._tryBase64(a);if(b)return b;var c=document.createElement("canvas");c.width=a.width,c.height=a.height;var d=c.getContext("2d");return d.drawImage(a,0,0),this._canvas=c,this._lastUrl=i+(new Date).valueOf(),this._lastUrl}return""},get:function(a){return this._lastUrl===a?this._canvas:!(!a||0!==a.indexOf(i)||a.length>i.length+30)&&null}},a}(),i=f.createClass(c,{constructor:function(a,b){if(c.call(this),this._data={},this._allowClear=a!==!1,this._readOnly=!1,b&&"object"==typeof b){this._config=b;for(var d in b)b.hasOwnProperty(d)&&b[d]&&b[d].hasOwnProperty("defValue")&&(this._data[d]=b[d].defValue)}},destroy:function(){this.un(),this._data=null,this._config=null},getData:function(a){return a?this._data:f.copy(this._data)},enumValues:function(a,b){this._readOnly=!0;for(var c in this._data)this._data.hasOwnProperty(c)&&a.call(b,c,this._data[c]);this._readOnly=!1},keys:function(){return Object.keys(this._data)},get:function(a){return this._data[a]},set:function(a,b){if(!this._readOnly&&a){var c=typeof a;if("string"===c){var d=this._data[a];b=this._translateValue(a,b),d!==b&&(this._testValue(a,b)?(this._data[a]=b,this.emit("set",{name:a,oldValue:d,value:b})):this.emit("reject",{name:a,oldValue:d,value:b}))}else if("object"===c)for(var e in a)a.hasOwnProperty(e)&&this.set(e,a[e])}return this},_translateValue:function(a,b){var c=this._config;return c&&c.hasOwnProperty(a)&&c[a]&&c[a].translate?c[a].translate(b):b},_testValue:function(a,b){if(!this._allowClear&&null==b)return!1;if(this._config){if(!this._config.hasOwnProperty(a))return!1;var c=this._config[a];if(c&&c.check)return"function"==typeof c.check?c.check(b):"string"==typeof c.check?typeof b===c.check:c.check.test?c.check.test(b):c.check.indexOf(b)>=0}return!0},clear:function(a){if(this._readOnly||!this._allowClear)return this;if(a){if("string"==typeof a&&this._data.hasOwnProperty(a)){var b=this._data[a];delete this._data[a],this.emit("clear",{name:a,oldValue:b})}}else for(var c=this.keys(),d=0;d<c.length;++d)this.clear(c[d]);return this}}),j={getCoords:function(a,b,c){c=c||new e;var d=a.getBoundingClientRect();return c.set(Math.round(d.left),Math.round(d.top),Math.round(d.right),Math.round(d.bottom)),b&&c.move(window.pageXOffset,window.pageYOffset),c},setStyle:function(a,b){this.copy(b,a.style,!0)},setPos:function(a,b,c){b&&"object"==typeof b&&(c=b.top||b.y||0,b=b.left||b.x||0),a&&(a.style.left=b+"px",a.style.top=c+"px")},setSize:function(a,b){a&&b&&(a.style.width=("function"==typeof b.width?b.width():b.width||0)+"px",a.style.height=("function"==typeof b.height?b.height():b.height||0)+"px")},setBound:function(a,b,c){a&&b&&(this.setPos(a,b),c?(a.style.right=c.right-b.right+"px",a.style.bottom=c.bottom-b.bottom+"px"):this.setSize(a,b))},removeChilds:function(a,b){for(;a.lastChild;)b&&b.unshift(a.lastChild),a.removeChild(a.lastChild);return b},createElement:function(a){if(!a)return document.createElement("div");a=a.split(".");var b=document.createElement(a[0]||"div");return a[1]&&(b.className=a[1]),b},appendChilds:function(a,b){for(var c=0;c<b.length;++c)a.appendChild(b[c])},isParent:function(a,b){for(;b;){if(b==a)return!0;b=b.parentNode}return!1},_addOrRemoveListeners:function(a,b,c,d){if(b&&c){a+="EventListener";for(var e in c)c.hasOwnProperty(e)&&"function"==typeof c[e]&&b[a](e,c[e],!!d)}},addListeners:function(a,b,c){this._addOrRemoveListeners("add",a,b,c)},removeListeners:function(a,b,c){this._addOrRemoveListeners("remove",a,b,c)},getImageSize:function(a){var b=a?{width:a.naturalWidth||a.width,height:a.naturalHeight||a.height}:null;return b&&"number"==typeof b.width?b:null},isTaintedImage:function(a){if(!a)return!1;if("IMG"==a.tagName)return f.isCrossOrigin(location.href,a.src);if("CANVAS"==a.tagName)try{return a.getContext("2d").getImageData(0,0,1,1),!1}catch(b){return!0}return!1},isGoodImage:function(a){return a&&1===a.nodeType&&/^(?:IMG|CANVAS)$/.test(a.tagName)&&!j.isTaintedImage(a)},_tempDiv:null,createCanvas:function(a,b,c){if(b=b||this.getImageSize(a),!b)return null;this._tempDiv||(this._tempDiv=document.createElement("div")),this._tempDiv.innerHTML=f.applyTemplate('<canvas width="${width}" height="${height}"></canvas>',b);var d=this._tempDiv.firstChild;return this._tempDiv.removeChild(d),this.isGoodImage(a)&&g.copyImage(a,d,c),d},createNodes:function(a){return a?(this._tempDiv||(this._tempDiv=document.createElement("div")),this._tempDiv.innerHTML=a,this.removeChilds(this._tempDiv,[])):[]},bgImageUrl:function(a,b,c){var d=this.createCanvas({width:2*a,height:2*a}),e=d.getContext("2d");return e.fillStyle=b,e.fillRect(0,0,a,a),e.fillRect(a,a,a,a),e.fillStyle=c,e.fillRect(0,a,a,a),e.fillRect(a,0,a,a),d.toDataURL("image/png")},getInsertPoint:function(a,b,c){var d={x:0,y:0};return a.width<b.width&&(d.x=Math.round((b.width-a.width)/2)),a.height<b.height&&(d.y=Math.round((b.height-a.height)/2)),d},textSplit:function(a){var b=a.value.split(/\r?\n/);return b}},k=f.createClass(c,{constructor:function(b,d){c.call(this),this._dom=b,this.root=d,this._back=null,this._front=null,this._inner=null,this._movingTimer=new a(800,function(){this.moving(!1)},this,(!0));var f=/jscpc-object-([a-z0-9]+)/.exec(d.className);this._objType=f?f[1]:"",this._createDOM(),this.rect=e(),this._setVisible(!1),this.enableDND(!1)},getType:function(){return this._objType},getName:function(){return this._objType},appendChild:function(a,b){return a&&b&&("back"===b&&(b=this.getBack()),"front"===b&&(b=this.getFront()),"inner"===b&&(b=this._inner),b.appendChild(a)),a},createGrip:function(a,b){return this.appendChild(this._dom.createGrip(a),b)},_grips:["t","r","b","l","lt","rt","rb","lb"],_enabledMove:!0,_createDOM:function(){var a=j.removeChilds(this.root,[]);this.root.innerHTML='<div class="jscpc-obj_inner jscpc-dashborder"></div>',this._inner=this.root.firstChild,this._enabledMove&&this._inner.setAttribute("data-grip","move"),j.appendChilds(this._inner,a);for(var b=this._grips,c=0;c<b.length;++c)this._dom.createGrip(b[c],this._inner,!0)},_gripParent:function(){return this._inner},destroy:function(){this.root&&(this._moveTimer.destroy(),this.un()._destroy(),this._dom.removeObject(this.getName()),this.root.parentNode.removeChild(this.root),this._back&&this._back.parentNode&&this._back.parentNode.removeChild(this._back),this._front&&this._front.parentNode&&this._front.parentNode.removeChild(this._front),this._dom=null,this._inner=null,this._back=null,this._front=null,this.root=null)},_setRootAttr:function(a,b,c){this.root.setAttribute(a,b),c&&this._inner&&this._inner.setAttribute(a,b),this._back&&this._back.setAttribute(a,b),this._front&&this._front.setAttribute(a,b)},mode:f.property("_mode",function(a,b){this._setRootAttr("data-mode",a),this._changeMode(a,b)}),moving:f.property("_moving",function(a,b){this._setRootAttr("data-moving",a,!0),this._changeMoving(a,b)},function(a){this._movingTimer.stop()}),enableDND:f.property("_enableDND",function(a,b){var c=this._inner||this.root;c.__disabledGrip=!a,this._setRootAttr("data-hidegrips",!a,!0)}),getOffsetNode:function(){return this._inner||this.root},visible:function(){return this._visible},_bufRect:e(),visibleIn:function(a,b){return a=this._bufRect.set(a||this._dom.getObject("bg").rect).clip(b||this.rect),this._visible&&a.minSize()>0},_setVisible:function(a){this._visible=a;var b=a?"":"none";this.root.style.display=b,this._back&&(this._back.style.display=b),this._front&&(this._front.style.display=b)},hide:function(){return this._visible&&(this._movingTimer.timeout(),this._beforeHide(),this._setVisible(!1),this.rect.zero(),this._hide(),this.emit("hide")),this},show:function(a){return a?(a.clone(this.rect,!0).normalize(),this.rect.minSize()<1?this.hide():(this._setBound(),this._gripParent().setAttribute("data-gripsize",this.rect.minSize()<22?"small":"normal"),this._setVisible(!0),this.emit("resize"),this)):this},move:function(a,b,c){return this._visible&&(c&&(this.moving(!0),this._movingTimer.setInterval(c).start()),this.rect.move(a,b),this.show(this.rect)),this},getBack:function(){if(!this._back){this._back=this._dom.appendChild(this._createBack(),"back"),this._back.style.display=this._visible?"":"none";var a=window.getComputedStyle(this._back);this._backPosition=a.getPropertyValue("position"),this._back.__objectName=this.getName()}return this._back},getFront:function(){if(!this._front){this._front=this._dom.appendChild(this._createFront(),"front"),this._front.style.display=this._visible?"":"none";var a=window.getComputedStyle(this._front);this._frontPosition=a.getPropertyValue("position"),this._front.__objectName=this.getName()}return this._front},_setBound:function(){j.setBound(this.root,this.rect),"absolute"===this._backPosition?j.setBound(this._back,this.rect):j.setPos(this._back,this.rect),"absolute"===this._frontPosition?j.setBound(this._front,this.rect):j.setPos(this._front,this.rect)},_createBack:function(){var a=j.createElement("."+this._backClassName);return j.setPos(a,this.rect),a},_createFront:function(){var a=j.createElement("."+this._frontClassName);return j.setPos(a,this.rect),a},_backClassName:"jscpc-objparent",_frontClassName:"jscpc-objparent",_hide:function(){},_beforeHide:function(){},_changeMode:function(a,b){},_changeMoving:function(a,b){},_destroy:function(){}}),l=f.createClass(k,function(a,b){return{constructor:function(a,c){b.call(this,a,c),this.getBack(),this.enableDND(!0)},_backClassName:"jscpc-select-outer",_changeMode:function(a,b){var c=a==this.MODE_CROP;this._inner.setAttribute("data-event-dblclick",c?"applycrop":""),this._inner.setAttribute("data-bordertype",c?"shadow":"inner")},MODE_CROP:"crop",MODE_SELECT:"select"}}),m=f.createClass(c,{constructor:function(a,b,d){c.call(this),this.cursor=a,this._area=a.parentNode,this._overlay=b,this._margin=d.margin?"-"+d.margin+"px":"0",this._hpLeft=0,this._hpTop=0,this._point={x:0,y:0},this._futurePoint={x:0,y:0},this.enable(!1).visible(!0).mode("none").moveInAreaOnly(!1);var e=this;this._overlay.onmouseover=function(a){return e._events.mouseover.call(e,a)},this._overlay.onmousemove=function(a){return e._events.mousemove.call(e,a)},this._overlay.onmouseout=function(a){return e._events.mouseout.call(e,a)}},destroy:function(){this.un(),this._overlay.onmouseover=null,this._overlay.onmousemove=null,this._overlay.onmouseout=null},_events:{mouseover:function(){"none"!==this._mode&&this._showCursor(!0)},mousemove:function(a){if("none"!==this._mode){var b=this._area.getBoundingClientRect();this._futurePoint.x=a.clientX-Math.round(b.left),this._futurePoint.y=a.clientY-Math.round(b.top),this._noMoveCursor=!0,this.emit("mousemove",this._futurePoint),this._noMoveCursor=!1,this._setPos(this._futurePoint.x,this._futurePoint.y),this._showCursor(!0),a.stopPropagation()}},mouseout:function(){this._showCursor(!1)}},_visibleDOM:function(){return this._enable&&this._visible},enable:f.property("_enable",function(a){a||this._showCursor(!1),this._overlay.style.display=this._visibleDOM()?"":"none"}),visible:f.property("_visible",function(a){a||this._showCursor(!1),this._overlay.style.display=this._visibleDOM()?"":"none"}),_setPos:function(a,b){this._point.x=a,this._point.y=b,this._noMoveCursor||(this.cursor.style.left=this._point.x-this._hpLeft+"px",this.cursor.style.top=this._point.y-this._hpTop+"px")},setHotPoint:function(a,b){return this._hpLeft=a,this._hpTop=b,this.enable()&&this._setPos(this._point.x,this._point.y),this},setSize:function(a,b){return this.cursor.style.width=a+"px",this.cursor.style.height=b+"px",this},setStyle:function(a,b){return this.cursor.style[a]=b,this},setBG:function(a){return this.cursor.style.background=a,this},setAttrs:function(a){for(var b in a)a.hasOwnProperty(b)&&this.cursor.setAttribute(b,a[b]);return this},mode:f.property("_mode",function(a){this.cursor.setAttribute("data-mode",a),"none"===a&&(j.removeChilds(this.cursor),this.setBG(""))}),moveInAreaOnly:f.property("_moveInAreaOnly",function(a){var b=a?"0":this._margin;this._overlay.style.left=b,this._overlay.style.top=b,this._overlay.style.right=b,this._overlay.style.bottom=b}),_showCursor:function(a){this.cursor.style.display=a&&this._visibleDOM()?"":"none"}}),n=function(){var a=["back","front","main"];return f.createClass(c,{constructor:function(a,b){c.call(this),this.config=b,this._createDOM(a,b),this._tempPixelCanvas=j.createCanvas({width:1,height:1}),this._tempPixelCtx=this._tempPixelCanvas.getContext("2d"),this.rect=e(),this.areaRect=e(),this.bgOffset={left:0,top:0},this._delayedResize=!1;var d=this.root.querySelector(".jscpc-object-bg"),f=this.root.querySelector(".jscpc-object-frame"),g=this.root.querySelector(".jscpc-object-text"),h=this.root.querySelector(".jscpc-object-select");this._objects={bg:new s(this,d),frame:new r(this,f),text:new t(this,g),select:new l(this,h)};var i=this.root.querySelector(".jscpc-cursor"),k=this.root.querySelector(".jscpc-overlay");this.cursor=new m(i,k,b),this.mode(this.MODE_NORMAL),this.getBG().on("_eventsBG",this),this.getSelection().on("_eventsSelection",this),this.getBG().replaceCanvas(j.createCanvas(b)),this.getBG().resizeByCanvas()},_eventsBG:{resize:function(){this._resizeOuter()}},_eventsSelection:{resize:function(){this._resizeOuter()},hide:function(){this._resizeOuter()}},destroy:function(){this.un();for(var a in this._objects)this._objects.hasOwnProperty(a)&&this._objects[a].destroy();if(this._hasRootParent)for(;this.root.lastChild;)this.root.removeChild(this.root.lastChild);else this.root.parentNode.removeChild(this.root);this.cursor.destroy(),this.cursor=null,this.root=null,this._layers=null,this._objects=null},_createDOM:function(b,c){this.root=b||document.createElement("div"),this._hasRootParent=!!this.root.parentNode,this.root.className=(this.root.className?this.root.className+" ":"")+"jscpc-root",this.root.style.borderWidth=c.margin+"px",this.root.setAttribute("data-grip","root"),this.root.innerHTML=f.applyTemplate('<div class="jscpc-objparent jscpc-objparent-back"></div><div class="jscpc-objparent jscpc-objparent-front"></div><div class="jscpc-overlay"></div><div class="jscpc-area"><div class="jscpc-objparent jscpc-objparent-main""><div class="jscpc-object jscpc-object-bg"><div class="jscpc-object jscpc-object-frame"></div><div class="jscpc-object jscpc-object-text"></div></div><div class="jscpc-object jscpc-object-select"></div></div><div class="jscpc-cursor"></div></div>',c),this._bgStyle='transparent url("'+j.bgImageUrl(c.bgTileSize,c.bgTileColor1,c.bgTileColor2)+'") 0 0 repeat';var d=this.root.querySelector(".jscpc-area");d.style.background=this._bgStyle,this._layers={root:this.root,area:d};for(var e=0;e<a.length;++e)this._layers[a[e]]=this.root.querySelector(".jscpc-objparent-"+a[e])},getAreaCoords:function(){var a=this._layers.area.getBoundingClientRect();return{left:Math.round(a.left),top:Math.round(a.top),right:Math.round(a.right),bottom:Math.round(a.bottom)}},appendChild:function(a,b){return a&&b&&("string"==typeof b&&(b=this._layers[b]),b.appendChild(a)),a},createGrip:function(a,b,c){var d=j.createElement(c?"p.jscpc-grip":"p.jscpc-grip jscpc-object-grip");return d.setAttribute("data-grip",a),this.appendChild(d,b)},removeObject:function(a){delete this._objects[a]},getObject:function(a,b){var c=this._objects[a];return!c||b&&!c.visible()?null:c},getActiveLayer:function(){return this.getObject("frame",!0)||this.getBG()},getSelection:function(a){return this.getObject("select",a)},getBG:function(){return this.getObject("bg")},getPixelColor:function(a,b){var c=this.getBG();if(!c.rect.hasPoint(a,b))return null;var d=this.getObject("frame",!0);if(!d||!d.rect.hasPoint(a,b))return c.getPixelColor(a,b);var e=d.getPixelColor(a-d.rect.left,b-d.rect.top);if(255===e[3])return e;if(0===e[3])return c.getPixelColor(a,b);this._tempPixelCtx.globalCompositeOperation="copy",this._tempPixelCtx.drawImage(c.getResizedCanvas(),a,b,1,1,0,0,1,1),this._tempPixelCtx.globalCompositeOperation="source-over",this._tempPixelCtx.drawImage(d.getResizedCanvas(),a-d.rect.left,b-d.rect.top,1,1,0,0,1,1);var f=this._tempPixelCtx.getImageData(0,0,1,1);return f.data},_moveObjects:function(b,c){var d=this.bgOffset;if(d.left!==b||d.top!==c){d.left=b,d.top=c;for(var e=0;e<a.length;++e)j.setPos(this._layers[a[e]],d)}},_resizeOuter:function(){if(this.mode()==this.MODE_SELECTING)return void(this._delayedResize=!0);this._delayedResize=!1;var a=this.getBG().rect,b=this.getSelection(!0);b&&b.mode()==b.MODE_CROP&&(a=a.clone().union(b.rect));var c=a.left<0?-a.left:0,d=a.top<0?-a.top:0;this._moveObjects(c,d);var e=a.width(),f=a.height(),g=!1,h=!1,i=this.mode()==this.MODE_RESIZING;this.areaRect.right===e&&this.areaRect.bottom===f||(h=i,this.areaRect.set(e,f),this._layers.area.style.width=e+"px",this._layers.area.style.height=f+"px"),this.mode()===this.MODE_RESIZING||this.rect.right===e&&this.rect.bottom===f||(g=!0,this.rect.set(e,f),this.root.style.width=e+"px",this.root.style.height=f+"px"),(h||g)&&this.emit(g?"resize":"resizing")},getGrip:function(a,b){if(b=b||{},b.move=b.move!==!1,b.resize=b.resize!==!1,b.root=b.root!==!1,b.move||b.resize)for(;a&&a!=this.root;){var c=a.parentNode,d=a.__disabledGrip||c&&c.__disabledGrip;if(!d){var e=a.getAttribute("data-grip");if("none"==e)return null;if("root"==e)return b.root?{node:a,grip:e}:null;if(e){if("move"==e&&!b.move)continue;if(!b.resize)continue;return{node:a,grip:e}}}a=c}return b.root?{node:this.root,grip:"root"}:null},getObjectByNode:function(a){for(;a&&a!=this.root;){if(/jscpc-object\b/.test(a.className)){for(var b in this._objects)if(this._objects.hasOwnProperty(b)){var c=this._objects[b];if(c.root==a)return c}return null}if(a.__objectName)return this.getObject(a.__objectName);a=a.parentNode}return null},showSystemCursor:f.property("_showSystemCursor",function(a){this.root.setAttribute("data-systemcursor",a)}),MODE_NORMAL:0,MODE_SELECTING:1,MODE_RESIZING:2,mode:f.property("_mode",function(a,b){if(this._layers.area.setAttribute("data-resizing",a==this.MODE_RESIZING),b==this.MODE_RESIZING)this._resizeOuter();else if(b==this.MODE_SELECTING&&this._delayedResize){var c=this.getSelection(!0);c?c.show(c.rect):this._resizeOuter()}})})}(),o=function(){var b=f.createClass(c,{constructor:function(b){c.call(this),this._config=b,this._kbEvents=f.bindAll(this._kbEvents,this),this._createDOM(),this._focusTimer=new a(300,this.focus,this,(!0))},destroy:function(){this.un(),this._focusTimer.stop(),j.removeListeners(this._kbHandler,this._kbEvents),this._parent.parentNode.removeChild(this._parent),this._parent=null,this._kbEvents=null,this._kbHandler=null},_createDOM:function(){this._parent=j.createElement(".jscpc-kbparent"),document.body.appendChild(this._parent),this._replaceHandler(!1)},_replaceHandler:function(a){j.removeListeners(this._kbHandler,this._kbEvents),this._kbHandler=j.createElement(".jscpc-kb-handler"),this._kbHandler.setAttribute("contenteditable","true"),this._parent.appendChild(this._kbHandler),j.addListeners(this._kbHandler,this._kbEvents),a!==!1&&this._focusTimer.stop().start()},_kbEvents:{paste:function(a){h.getImageFromEvent(a,this._pasteImage,this,this._replaceHandler)},copy:function(a){this._handleCopyEvent(a)},cut:function(a){this._handleCopyEvent(a)&&this.emit("del",{event:a})},keydown:function(a){var b;a=a||window.event;var c=d[a.keyCode];return c?(c.preventDefault?a.preventDefault():this._focusTimer.stop().start(),void((!c.cmdKeyTest||a.ctrlKey||a.metaKey)&&(b={event:a},"move"===c.command&&(b.direction=e[a.keyCode]),this.emit(c.command,b)))):void this._focusTimer.stop().start()}},_handleCopyEvent:function(a){var b=this.emit("requestCopyData",a.type,!0);return!!b&&(this._insertToCB(b,a)===!1&&a.preventDefault(),!0)},_setSelection:function(){if(this._kbHandler){!this._kbHandler.firstChild||this._kbHandler.firstChild.nextSibling||3!=this._kbHandler.firstChild.nodeType?this._kbHandler.innerHTML="1":(!this._kbHandler.firstChild.data||this._kbHandler.firstChild.data.length>5)&&(this._kbHandler.firstChild.data="1");try{window.getSelection().selectAllChildren(this._kbHandler)}catch(a){}}},focus:function(){this._focusTimer.started()||(this._setSelection(),this._kbHandler.focus())},_insertToCB:function(a,b){if(b.clipboardData&&b.clipboardData.setData)try{return b.clipboardData.setData("text/plain",a),!1}catch(c){}if(window.clipboardData&&window.clipboardData.setData)try{if(window.clipboardData.setData("Text",a))return!1}catch(d){}this._kbHandler.innerHTML=a,window.getSelection().selectAllChildren(this._kbHandler),this._focusTimer.stop().start()},_pasteImage:function(a){(a.img||a.url)&&this.emit("pasteImage",a)}}),d={9:{preventDefault:!0,command:"tab"},13:{preventDefault:!0,command:"enter"},27:{preventDefault:!0,command:"escape"},46:{preventDefault:!0,command:"del"},37:{preventDefault:!0,command:"move"},65:{preventDefault:!0,command:"selectAll",cmdKeyTest:!0},89:{preventDefault:!0,command:"redo",cmdKeyTest:!0},90:{preventDefault:!0,command:"undo",cmdKeyTest:!0}};d[38]=d[39]=d[40]=d[37];var e={37:{name:"left",dx:-1,dy:0},38:{name:"top",dx:0,dy:-1},39:{name:"right",dx:1,dy:0},40:{name:"bottom",dx:0,dy:1}};return b}(),p=f.createClass(c,function(c,d){var g={MODE_RECT:"rect",MODE_PATH:"path",MODE_POINT:"point",constructor:function(c,e,g){d.call(this),this._dom=e,this._root=g,this._fileDNDTimer=new a(200,function(){this._root.setAttribute("data-dragover","false")},this,(!0)),this._dndConfig={ctx:this,distance:3,calcOffset:!0},b.create(this._root,this._dndEvents,this._dndConfig),this._rootMouseEvents=f.bindAll(this._rootMouseEvents,this),this._fileDNDEvents=f.bindAll(this._fileDNDEvents,this),j.addListeners(this._root,this._rootMouseEvents),j.addListeners(this._root,this._fileDNDEvents),this._mode=null,this._dndLast=!1,this._modeMap={},this._modeMap[this.MODE_RECT]=(new k).init(this,this._dom),this._modeMap[this.MODE_PATH]=(new l).init(this,this._dom),this._modeMap[this.MODE_POINT]=(new m).init(this,this._dom)},destroy:function(){this.un(),b.destroy(this._root),j.removeListeners(this._root,this._rootMouseEvents),j.removeListeners(this._root,this._fileDNDEvents),this._rootMouseEvents=null,this._fileDNDEvents=null,this._dndConfig=null,this._root=null},_rootMouseEvents:{dblclick:function(a){this._rootMouseEvent(a)},click:function(a){this._rootMouseEvent(a)},mouseup:function(a){this.emit("keyManagerFocus")}},_fileDNDEvents:{dragenter:function(a){},dragover:function(a){this._fileDNDTimer.stop().start(),this._root.setAttribute("data-dragover","true"),a.preventDefault()},dragleave:function(a){},drop:function(a){a.preventDefault(),a.stopPropagation(),this._fileDNDTimer.timeout(),h.getImageFromEvent(a,function(b){this._dropImage(b,a)},this)}},_dropImage:function(a,b){if(a.img||a.url){var c=this._dom.getAreaCoords();a.point={x:b.clientX-c.left,y:b.clientY-c.top},this.emit("dropImage",a)}},_rootMouseEvent:function(a){if(this._dndLast)return void(this._dndLast=!1);for(var b=a.target,c="data-event-"+a.type;b&&b!=this._root;){var d=b.getAttribute(c);if(d){var e=this._dom.getObjectByNode(b);return void(e&&e.emit(d,{node:b,event:a}))}b=b.parentNode}var f=this._dom.getAreaCoords();this.emit(a.type,{event:a,areaX:a.clientX-f.left,areaY:a.clientY-f.top})},_callEventRet:function(a,b){return this._mode[a]?this._mode[a](b):this.emit(a,b,!0)},_callEvent:function(a,b){return!!this._mode[a]&&(this._mode[a](b),!0)},_dndEvents:{dndGetOffsetNode:function(a){return this._params?(this._params.useActiveLayer?this._dom.getActiveLayer():this._dom.getBG()).getOffsetNode():null},dndMouseDown:function(a){if(!this._mode)return this._dndLast=!1,!1;if("TEXTAREA"===a.target.tagName||"INPUT"===a.target.tagName)return this._dndLast=!1,!1;var b=this._dom.getGrip(a.target,{move:this._mode.canMove(),resize:this._mode.canResize(),root:this._mode.canRoot()});if(!b)return this._dndLast=!1,!1;a.data.mm={grip:b.grip,gripNode:b.node},"root"!=b.grip&&(a.data.mm.object=this._dom.getObjectByNode(b.node));var c=this._callEventRet("dndMouseDown",a);return c!==!1?this._dom.cursor.visible(!1):this._dndLast=!1,c},dndStart:function(a){return this._callEventRet("dndStart",a)},dndMove:function(a){var b=a.data.mm.grip,c="dndMove"+("root"==b?"Root":"move"==b?"Move":"Resize");this._callEvent(c,a)||this._callEvent("dndMove",a),this.emit("dndMove",a)},dndStop:function(a){this._dndLast=!0,this._callEvent("dndStop",a),this.emit("dndStop",a)},dndSkip:function(a){this._dndLast=!1,this._callEvent("dndSkip",a),this.emit("dndSkip",a)},dndMouseUp:function(a){this._dom.cursor.visible(!0),this._callEvent("dndMouseUp",a),this.emit("dndMouseUp",a)}},setMode:function(a,b){return(a=this._modeMap[a])?(this._mode=a,this._params=b||{},this):this},getParams:function(){return this._params;
}},i=f.createClass(null,{init:function(a,b){return this._mm=a,this._dom=b,this},canMove:function(){return!0},canResize:function(){return!0},canRoot:function(){return this.getParams().gripRoot!==!1},getParams:function(){return this._mm.getParams()}}),k=f.createClass(i,{dndStart:function(a){var b=a.data.mm.object;return a.data.mm.rect=b?b.rect.clone(!0):new e,b&&(a.data.mm.startRect=b.rect.clone(!0)),a.data.mm.startLT=a.data.mm.rect.point(),this._mm.emit("dndStart",a,!0)},dndMoveRoot:function(a){var b=this.getParams();a.data.mm.rect.set(a.start.nodeX,a.start.nodeY,!0).resize("rb",{resizeType:a.current.shiftKey&&b.shiftRootResizeType,x:a.current.nodeX,y:a.current.nodeY,minSize:b.minSize}).clip(b.rootClip)},dndMoveMove:function(a){var b=this.getParams();a.data.mm.rect.moveTo(a.data.mm.startLT.x+a.current.nodeX-a.start.nodeX,a.data.mm.startLT.y+a.current.nodeY-a.start.nodeY).into(b.moveIntoRect||a.current.shiftKey&&b.shiftMoveIntoRect)},dndMoveResize:function(a){var b=this.getParams();a.data.mm.rect.resize(a.data.mm.grip,{resizeType:b.resizeResizeType||a.current.shiftKey&&e.RT_AVG,x:a.current.nodeX,y:a.current.nodeY,positiveOnly:b.resizePositiveOnly,minSize:b.minSize})}}),l=f.createClass(i,{dndMouseDown:function(a){return a.data.mm.path=[a.start.nodeX,a.start.nodeY],a.data.mm.boundingRect=new e(a.start.nodeX,a.start.nodeY,a.start.nodeX+1,a.start.nodeY+1),this._mm.emit("dndMouseDown",a,!0)},dndMove:function(a){var b=a.data.mm.lastLine=a.data.mm.lastLine||[];b[0]=a.old.nodeX,b[1]=a.old.nodeY,b[2]=a.current.nodeX,b[3]=a.current.nodeY,a.data.mm.path.push(a.current.nodeX,a.current.nodeY),a.data.mm.boundingRect.unionWithPoint(a.current.nodeX,a.current.nodeY,!0)}}),m=f.createClass(i,{dndMouseDown:function(a){return this._mm.emit("mousedown",a),!1},canMove:function(){return!1},canResize:function(){return!1}});return g}),q=f.createClass(k,{constructor:function(a,b){k.call(this,a,b),this.canvas=null,this._resizedCanvas=null,this._tempCanvas=null},_destroy:function(){this.canvas=null,this._resizedCanvas=null,this._tempCanvas=null},getCanvas:function(){return this.canvas},getContext:function(){return this.canvas?this.canvas.getContext("2d"):null},getOffsetNode:function(){return this._inner},restoreTempCanvasImage:function(a){var b=this._tempCanvas.getContext("2d"),c=b.globalCompositeOperation;if(b.globalCompositeOperation="copy",a){var d=a.left,e=a.top,f=a.width(),g=a.height();b.save(),b.beginPath(),b.rect(d,e,f,g),b.clip(),b.drawImage(this.getResizedCanvas(),d,e,f,g,d,e,f,g),b.restore()}else b.drawImage(this.getResizedCanvas(),0,0);b.globalCompositeOperation=c},getTempContext:function(a,b){return this.getTempCanvas(a,b).getContext("2d")},getTempCanvas:function(a,b){var c=this.rect.size();return this._tempCanvas?(c.width!=this._tempCanvas.width&&(this._tempCanvas.width=c.width),c.height!=this._tempCanvas.height&&(this._tempCanvas.height=c.height)):(this._tempCanvas=j.createCanvas(c),this._tempCanvas.className="jscpc-tempcanvas",this._inner.appendChild(this._tempCanvas)),a&&(this.restoreTempCanvasImage(b),this.hideCanvas()),this._tempCanvas.style.display="",this._tempCanvas},hideCanvas:function(){this.canvas.style.display="none"},hideTempCanvas:function(){if(this.canvas.style.display="",this._tempCanvas){this._tempCanvas.style.display="none",this._tempCanvas.style.opacity=1;var a=this._tempCanvas.getContext("2d");g.resetGlobals(a),a.clearRect(0,0,this._tempCanvas.width,this._tempCanvas.height)}},SST_DATA:"data",SST_CANVAS:"canvas",_calcRectForSlice:function(a,b){var c=this._bufRect.set(this.rect).move(-this.rect.left,-this.rect.top);return a=a?b!==!1?a:c.clip(a):c,e.hasArea(a)?a:null},getImageData:function(a){if(a=this._calcRectForSlice(a)){var b=this.getResizedCanvas().getContext("2d");return new g.ImageData(b,a)}return null},getSnapshot:function(a,b){if(a=this._calcRectForSlice(a,b)){var c=j.createCanvas(a.size()),d=c.getContext("2d");return d.drawImage(this.getResizedCanvas(),-a.left,-a.top),c}return null},getPixelColor:function(a,b){var c=this.getResizedCanvas().getContext("2d"),d=c.getImageData(a,b,1,1);return d.data},_testSize:function(a){return!a||this.rect.width()==a.width&&this.rect.height()==a.height},resized:function(){var a=this.visible()&&!this._testSize(this.canvas);return a&&this.canvas||(this._resizedCanvas=null),a},getResizedCanvas:function(){return this.visible()&&this.canvas?this._testSize(this.canvas)?(this._resizedCanvas=null,this.canvas):(this._resizedCanvas&&(this._testSize(this._resizedCanvas)||(this._resizedCanvas=null)),this._resizedCanvas||(this._resizedCanvas=j.createCanvas(this.canvas,this.rect.size(),!0)),this._resizedCanvas):(this._resizedCanvas=null,null)},clearResizedCanvas:function(){this._resizedCanvas=null},replaceCanvas:function(a){var b=this.canvas;this.canvas=a;var c=this._inner;return b?a?c.replaceChild(a,b):c.removeChild(b):a&&c.insertBefore(a,c.firstChild),this._resizedCanvas=null,b},resizeByCanvas:function(a){return this._resizedCanvas=null,this.canvas?this.show(this.rect.resize("rb",j.getImageSize(this.canvas)).saveProportions()):(a&&this.hide(),this)}}),r=f.createClass(q,{constructor:function(a,b){q.call(this,a,b),this._inner.setAttribute("data-bordertype","outer")},create:function(a,b,c){if(!b||this.visible())return this;a=a||this._dom.getObject("bg");var d=a.getSnapshot(b);return c||g.drawImage(a.canvas,b,!0),this.insert(d,b)},insert:function(a,b){return this.replaceCanvas(a),this.show(b),this},draw:function(a){return this.visible()?(a=a||this._dom.getObject("bg"),g.drawImage(a.canvas,this.rect,!1,this.getResizedCanvas()),this):this},remove:function(){return this.visible()?(this.canvas&&(this._inner.removeChild(this.canvas),this.canvas=null),this._resizedCanvas=null,this.hide()):this}}),s=f.createClass(r,{constructor:function(a,b){q.call(this,a,b)},_grips:["r","b","rb"],_enabledMove:!1}),t=f.createClass(k,function(b,c){var d=(e(),{width:76,height:40}),f={width:4,height:4},h={x:0,y:0};return{constructor:function(b,d){c.call(this,b,d),this._font=null,this._createAdditionalDOM(),this._timer=new a(200,this._updateSize,this),this._lastText=null,this._lastFont=null,this._lastWidth=0;var e=this;this._onblur=function(){e.mode(e.MODE_PREVIEW)},this._textarea.oninput=function(){e._updateSize()},this._textarea.onkeydown=function(a){return 9==a.keyCode?(a.preventDefault(),e.emit("tab"),!1):27==a.keyCode?(a.preventDefault(),e.emit("escape"),!1):void 0},this.mode(this.MODE_PREVIEW),this.enableDND(!0)},_destroy:function(){this._textarea.onblur=null,this._onblur=null,this._timer.stop()},_beforeHide:function(){this._textarea.value="",this._clearCanvas(),this._strings=null,this.mode("")},_hide:function(){},_grips:[],_enabledMove:!1,_frontClassName:"jscpc-objparent-abs jscpc-objparent-text-front",_createAdditionalDOM:function(){var a=j.createNodes('<div class="jscpc-obj_inner jscpc-dashborder" data-bordertype="outer" data-grip="move" data-event-click="beginedit"><div class="jscpc-ti_editor"><textarea></textarea></div><div class="jscpc-ti_toolbar" data-grip="none"><div class="jscpc-button24 jscpc-image-cancel24" data-event-click="btnclose"></div><div class="jscpc-button24 jscpc-image-ok24" data-event-click="applytext"></div></div></div><div class="jscpc-ti_preview"><canvas width="1" height="1"></canvas></div>');this._frontInner=this.appendChild(a[0],"front");var b=this._frontInner.querySelector(".jscpc-ti_editor");this._textarea=b.firstChild;var c=this.appendChild(a[1],"inner");this._canvas=c.firstChild},_selfHandlers:{btnclose:function(){this.hide()},beginedit:function(){this.mode(this.MODE_EDIT)}},showAt:function(a,b){this.rect.moveTo(a,b),this.rect.width()<1&&(this.rect.right=a+d.width),this.rect.height()<1&&(this.rect.bottom=b+d.height),this.show(this.rect)},getMinSize:function(){return d},getStrings:function(){return this._strings},getText:function(){return this._textarea.value},setFont:function(a){this.ctxOptions=g.text.makeTextOptions(a),this.lineHeight=a.fontSize+2,this._textarea.style.font=this.ctxOptions.font,this._textarea.style.lineHeight=this.lineHeight+"px",this._updateUI()},getOffset:function(){return h},_updateUI:function(){this.visible()&&(this._updateSize(),this._previewText())},_clearCanvas:function(){var a=this._canvas.getContext("2d");a.clearRect(0,0,this._canvas.width,this._canvas.height)},_previewText:function(){if(this.visible()&&this.mode()===this.MODE_PREVIEW){this._canvas.width<this.rect.width()&&(this._canvas.width=this.rect.width()),this._canvas.height<this.rect.height()&&(this._canvas.height=this.rect.height());var a=this._canvas.getContext("2d");a.clearRect(0,0,this.rect.width(),this.rect.height()),g.setOptions(a,this.ctxOptions),g.text.drawText(a,this._strings,this.getOffset(),this.lineHeight)}},_updateSize:function(){if(this.ctxOptions&&this.ctxOptions.font){var a=this._textarea.value;this._lastText===a&&this._lastFont===this.ctxOptions.font||(this._lastText=a,this._lastFont=this.ctxOptions.font,a?(j.setSize(this._textarea,f),this.rect.setSize("rb",{width:Math.max(this._textarea.scrollWidth,d.width),height:Math.max(this._textarea.scrollHeight+5,d.height)}),this._textarea.style.height=this._textarea.style.width=""):this.rect.setSize("rb",d.width),this.show(this.rect))}},_changeMode:function(a,b){if("edit"===a){this._timer.start(),this._textarea.focus();var c=this;setTimeout(function(){c._textarea.onblur=c._onblur},200)}else this._textarea.onblur=null;"preview"===a&&(this._timer.stop(),this.visible()&&(this._strings=j.textSplit(this._textarea),this._previewText()))},MODE_EDIT:"edit",MODE_PREVIEW:"preview",insert:function(a,b,c){this.select(a),this._textarea.value=b,this.setFont(c)}}}),u=(f.createClass(k,function(a,b){return{constructor:function(a,c){b.call(this,a,c),this.enableDND(!0)},_changeMode:function(a,b){}}}),f.createClass(null,{init:function(a,b){this._paint=a,this._dom=b,this._init()},_init:function(){}})),v=f.createClass(u,{undo:function(){this._action()},redo:function(){this._action()},_action:function(){}}),w=f.createClass(v,{constructor:function(a,b){this._layer=a,this._canvas=b},_action:function(){this._canvas=this._dom.getObject(this._layer).replaceCanvas(this._canvas)}}),x=f.createClass(u,{constructor:function(a,b){this._rect=a,this._copy=b},undo:function(){var a=this._dom.getObject("frame");this._copy||a.draw(),a.remove(!this._copy)},redo:function(){this._dom.getObject("frame").create(null,this._rect,this._copy)}}),y=f.createClass(u,{constructor:function(a,b){this._canvas=a,this._rect=b},undo:function(){this._dom.getObject("frame").remove()},redo:function(){this._dom.getObject("frame").insert(this._canvas,this._rect)}}),z=f.createClass(u,{constructor:function(a){this._rect=a&&a.clone(!0)},_init:function(){var a=this._dom.getObject("frame");this._rect=this._rect||a.rect.clone(!0),this._canvas=a.canvas},undo:function(){this._dom.getObject("frame").insert(this._canvas,this._rect)},redo:function(){this._dom.getObject("frame").remove()}}),A=f.createClass(u,{constructor:function(){},_init:function(){this._rect=this._dom.getObject("frame").rect.clone(!0);var a=this._dom.getBG();this._bgCanvas=a.getSnapshot(this._rect,!0)},undo:function(){g.drawImage(this._dom.getBG().canvas,this._rect,!0,this._bgCanvas)},redo:function(){this._dom.getObject("frame").draw()}}),B=f.createClass(u,{constructor:function(a,b,c){this._objectName=a,this._newRect=b.clone(!0).normalize(),this._oldRect=c&&c.clone(!0).normalize()},_init:function(){this._oldRect=this._oldRect||this._dom.getObject(this._objectName).rect.clone(!0)},undo:function(){this._dom.getObject(this._objectName).show(this._oldRect)},redo:function(){this._dom.getObject(this._objectName).show(this._newRect)},appendCommand:function(a){return this._newRect=a._newRect,!0}}),C=f.createClass(u,{constructor:function(a){this._innerCommand=a},_init:function(){this._innerCommand.init(this._paint,this._dom)},undo:function(){this._innerCommand.undo(),this._innerCommand.done=!1},redo:function(){this._innerCommand.redo(),this._innerCommand.done=!0},replaceInnerCommand:function(a){var b=this.done;b&&this.undo(),this._innerCommand=a,this._init(),b&&this.redo()}}),D=f.createClass(u,{setConfig:function(a,b,c){return this._objName=a,this._rect=b,this._options=c,this},undo:function(){if(this._snapshot){var a=this._dom.getObject(this._objName).canvas.getContext("2d");a.putImageData(this._snapshot.getData(),this._rect.left,this._rect.top)}},redo:function(){this._snapshot||(this._snapshot=this._dom.getObject(this._objName).getImageData(this._rect));var a=this._dom.getObject(this._objName),b=a.canvas.getContext("2d");g.setOptions(b,this._options),this._apply(b),g.resetGlobals(b)},_apply:function(a){}}),E=f.createClass(D,{constructor:function(a,b,c){this._imgData=a,this._isImageOrCanvas=!!a.tagName,!this._isImageOrCanvas&&this._imgData.isImageDataWrapper&&(this._imgData=this._imgData.getData()),this._x=b,this._y=c},_apply:function(a){this._isImageOrCanvas?a.drawImage(this._imgData,this._x,this._y):a.putImageData(this._imgData,this._x,this._y)}}),F=f.createClass(null,{constructor:function(a,b){this._paint=b,this._config=a,this.historyEventEmitter=new c,this.history=new d(a.historyLimit,this.historyEventEmitter)},setDOM:function(a){this._dom||(this._dom=a,this.historyEventEmitter.on("_eventsHistory",this))},destroy:function(){this.historyEventEmitter.un(),this.history.clear(),this.historyEventEmitter=null,this._paint=null,this.history=null,this._dom=null},_eventsHistory:{changing:function(){this._dom.getSelection().hide()}},getHistory:function(){var a=f.proxy(this.history,["undo","redo","undoLength","redoLength","isEmpty","clear"]);return c.mixin(a),this.historyEventEmitter.on("change",function(a){this.emit("change",a)},a),a},run:function(a,b){a.init(this._paint,this._dom),this.history.run(a,b)},runAll:function(a){if(a&&a.length){a.length>1&&this.history.beginBatch();for(var b=0;b<a.length;++b)a[b]&&a[b].init&&this.run(a[b]);a.length>1&&this.history.endBatch()}},replaceCanvas:function(a,b,c){this.history.beginBatch(),this.run(new w(a,b)),c&&this.moveObject(a,c,null,!0),this.history.endBatch()},applyResize:function(a){var b=this._dom.getObject(a,!0);if(b&&b.resized()){var c=b.getResizedCanvas();this.replaceCanvas(a,c)}},crop:function(a){var b=this._dom.getSelection(!0);if(a||b){a=e.get(a||b.rect).clone().normalize().resize("rb",{minSize:this._config._minSize}),this._dom.getSelection().hide(),this.history.beginBatch(),this.applyResize("bg");var c=a.left?-a.left:0,d=a.top?-a.top:0,f=this._dom.getObject("frame",!0);f&&(f.visibleIn(a)?(c||d)&&this.moveObject("frame",f.rect.clone(!0).move(c,d),null,!1):this.removeObject(!1));var g=this._dom.getBG(),h=g.getSnapshot(a,!0);this.moveObject("bg",a.moveTo(0,0).saveProportions(!0)),this.replaceCanvas("bg",h),this.history.endBatch()}},_moveFrame:function(a,b,c){this.run(new B(objName,a,b))},moveObject:function(a,b,c,d,e){var f=this._dom.getObject(a,!0);if(f&&"frame"===a&&e&&f.visibleIn(null,b))return void this.run(new B(a,b,c),e);if(this.history.beginBatch(),"bg"===a){var g=this._dom.getObject("frame",!0);g&&!g.visibleIn(b)&&this.run(new z)}f&&(d===!1||"bg"===a||f.visibleIn(null,b)?this.run(new B(a,b,c)):this.run(new z(c))),this.history.endBatch()},drawObject:function(){this._dom.getObject("frame",!0)&&(this.history.beginBatch(),this.applyResize("bg"),this.run(new A),this.history.endBatch())},removeObject:function(a){this._dom.getObject("frame",!0)&&(this.history.beginBatch(),a&&this.drawObject(),this.run(new z),this.history.endBatch())},createObject:function(a,b){var c=this._dom.getSelection(!0);(a||c)&&(a="all"===a?this._dom.getBG().rect.clone().saveProportions(!0):e.get(a||c.rect).clone().normalize().saveProportions(),this._dom.getSelection().hide(),this.history.beginBatch(),this.applyResize("bg"),this.removeObject(!0),a.minSize()>0&&this.run(new x(a,b)),this.history.endBatch())},insertImage:function(a,b,c){this._dom.getSelection().hide();var d=j.createCanvas(a);this.history.beginBatch(),this.removeObject(!0);var f=this._dom.getBG().rect;if(c.width>f.width()||c.height>f.height()){var g=e(c.width,c.height).union(f);this.crop(g)}f=this._dom.getBG().rect;var h=f.size();b?(b.x=Math.min(Math.max(b.x,0),f.width()-c.width),b.y=Math.min(Math.max(b.y,0),f.height()-c.height)):b=j.getInsertPoint(c,h,this._dom.root),this.run(new y(d,e(b,c).saveProportions())),this.history.endBatch()},newImage:function(a,b){this._dom.getSelection().hide(),this.history.beginBatch(),this.removeObject(!1),this.moveObject("bg",e(a).saveProportions()),this.replaceCanvas("bg",j.createCanvas(b,a)),this.history.endBatch()},runToolCommand:function(a,b){this.history.beginBatch(),this.applyResize(a),this.run(b),this.history.endBatch()}}),G=f.createClass(null,{constructor:function(){this._toolStarted=!1},_bufRect:new e,init:function(a,b,c,d,e,f){this._config=a,this._paint=b,this._runner=c,this._dom=d,this._mouseMgr=e,this._keyMgr=f,this._init()},destroy:function(){this.end(),this._destroy(),this._config=null,this._runner=null,this._dom=null,this._mouseMgr=null,this._keyMgr=null},begin:function(){this._toolStarted||(this._mouseMgr.on("_mouseHandlers",this),this._keyMgr.on("_keyHandlers",this),this._paint.tools.options.on("_toolOptionsHandlers",this),this._dom.cursor.on("_cursorHandlers",this),this._toolStarted=!0,this._begin())},end:function(){this._toolStarted&&(this._toolStarted=!1,this._end(),this._mouseMgr.un("_mouseHandlers",this),this._keyMgr.un("_keyHandlers",this),this._paint.tools.options.un("_toolOptionsHandlers",this),this._dom.cursor.un("_cursorHandlers",this))},_toolOptionsHandlers:null,_keyHandlers:null,_mouseHandlers:null,_cursorHandlers:null,_init:function(){},_destroy:function(){},_begin:function(){},_end:function(){}});e.prototype.toolResultRect=function(){var a=new e;return function(b,c){var d=c?Math.round(c/1.414+2):1;return this.normalize().expand(d).clip(a.set(b.rect).moveTo(0,0))}}();var H=f.createClass(G,{constructor:function(){G.call(this)},_mouseHandlers:{dndMouseDown:function(a,b){this._dom.mode(this._dom.MODE_RESIZING).getSelection().hide()},dndMove:function(a){this._dom.getBG().show(a.data.mm.rect)},dndStop:function(a){this._runner.moveObject("bg",a.data.mm.rect.saveProportions(),a.data.mm.startRect)},dndMouseUp:function(a){this._dom.mode(this._dom.MODE_NORMAL)}},_begin:function(){this._mouseMgr.setMode(this._mouseMgr.MODE_RECT,{gripRoot:!1,minSize:this._config._minSize,resizePositiveOnly:!0,resizeResizeType:e.RT_AVG}),this._dom.getSelection().hide(),this._dom.getBG().enableDND(!0)},_end:function(){this._dom.mode(this._dom.MODE_NORMAL),this._dom.getBG().enableDND(!1)}}),I=f.createClass(G,{constructor:function(){G.call(this)},_mouseHandlers:{dndMouseDown:function(a,b){var c=this._dom.mode(this._dom.MODE_SELECTING).getSelection().mode("crop");"root"==a.data.mm.grip&&c.hide()},dndMove:function(a){this._dom.getSelection().show(a.data.mm.rect)},dndMouseUp:function(a){this._dom.mode(this._dom.MODE_NORMAL)}},_keyHandlers:{move:function(a){this._dom.getSelection().move(a.direction.dx,a.direction.dy)},enter:function(a){this._runner.crop()},escape:function(a){this._dom.getSelection().hide()}},_selectionHandlers:{applycrop:function(a){this._runner.crop()}},_begin:function(){this._mouseMgr.setMode(this._mouseMgr.MODE_RECT,{handleDblClick:!0,minSize:this._config._minSize,shiftMoveIntoRect:this._dom.getBG().rect,shiftRootResizeType:e.RT_AVG}),this._dom.getSelection().hide().mode("crop").on("_selectionHandlers",this)},_end:function(){this._dom.mode(this._dom.MODE_NORMAL).getSelection().hide().un("_selectionHandlers",this)}}),J=f.createClass(G,function(b,c){var d=(new e,f.createClass(D,{constructor:function(a){this._points=a},_apply:function(a){g.shapes.drawBezier(a,this._points)}})),h=f.createClass(D,{constructor:function(a){this._arc=a},_apply:function(a){this._arc.draw(a)}}),i=f.createClass(u,{setConfig:function(b,c,d){this._toolOptions=b,this._objName=d,this._ctxOptions=null,this._canDraw=!1,this._grips=null,this._rect=new e,this._movingTimer=new a(100,function(){this.setMoving(!1)},this,(!0)),this._calcInitPoints(c,b.curve)},_init:function(){this._calcRect()},undo:function(){for(var a=0;a<this._grips.length;++a)this._grips[a].parentNode.removeChild(this._grips[a]);this._grips=null,this._dom.getObject(this._objName).hideTempCanvas()},redo:function(){var a=this._dom.getObject(this._objName);this._grips=[];for(var b=0,c=0;c<this._points.length;c+=2){var d=a.createGrip("move","front");d.__pointNum=b++,j.setPos(d,this._points[c],this._points[c+1]),this._grips.push(d)}this._createOptions(),this._draw()},setMoving:function(a){if(this._grips)for(var b=0;b<this._grips.length;++b)this._grips[b].setAttribute("data-moving",a)},createResultCommand:function(){this._createOptions();var a=this._createResultCommand();return a.setConfig(this._objName,this._rect,this._ctxOptions)},changeOptions:function(){this.done&&(this._createOptions(),this._draw())},_updateGrips:function(){for(var a=0;a<this._grips.length;++a)j.setPos(this._grips[a],this._points[2*a],this._points[2*a+1])},changePoint:function(a,b,c){this._setNewPointPos(a,b,c),this.done&&(this._updateGrips(),this._draw()),this._calcRect()},movePoints:function(a,b,c){if(a||b){c&&(this.setMoving(!0),this._movingTimer.stop().setInterval(c).start());for(var d=0;d<this._points.length;d+=2)this._points[d]=this._points[d]+a,this._points[d+1]=this._points[d+1]+b;this.done&&(this._updateGrips(),this._draw()),this._calcRect()}},_calcRect:function(){this._calcRectByCurveData(this._rect),this._rect.toolResultRect(this._dom.getObject(this._objName),this._toolOptions.lineWidth)},_createOptions:function(){this._ctxOptions=g.shapes.makeLineOptions(this._toolOptions,!1,this._dom.getObject(this._objName).rect)},_draw:function(){if(this._canDraw){var a=this._dom.getObject(this._objName).getTempContext();a.clearRect(this._rect.left,this._rect.top,this._rect.width(),this._rect.height()),g.setOptions(a,this._ctxOptions),this._drawCurve(a)}else this._canDraw=!0},_calcInitPoints:function(a,b){},_setNewPointPos:function(a,b,c){this._points[2*a]=b,this._points[2*a+1]=c},_calcRectByCurveData:function(a){},_drawCurve:function(a){},_createResultCommand:function(){}}),k=f.createClass(i,{_calcInitPoints:function(a,b){if(this._points=[a.left,a.top],/^bezier([23])$/.test(b))for(var c=parseInt(RegExp.$1,10),d=1;d<c;++d)this._points.push(Math.round(((c-d)*a.left+d*a.right)/c),Math.round(((c-d)*a.top+d*a.bottom)/c));this._points.push(a.right,a.bottom)},_calcRectByCurveData:function(a){a.fromPoints(this._points,!0)},_drawCurve:function(a){g.shapes.drawBezier(a,this._points)},_createResultCommand:function(){return new d(this._points)}},{drawByRect:function(a,b){g.shapes.drawLine(a,b)},calcClearRect:function(a,b){b.set(a)}}),l=f.createClass(i,{constructor:function(a){a&&this.set(a)},set:function(a){return this.raduis=a.diagonal(),this.angles=this.angles||[],this.angles[0]=0,this.angles[1]=a.angle()||2*Math.PI,this.points=this.points||[],this.points[0]=a.left,this.points[1]=a.top,this.points[2]=a.left+Math.round(this.raduis),this.points[3]=a.top,this.points[4]=a.right,this.points[5]=a.bottom,this},draw:function(a){a.beginPath(),a.arc(this.points[0],this.points[1],this.raduis,this.angles[0],this.angles[1]),a.stroke()},calcRect:function(a){var b=Math.ceil(this.raduis),c=this.points[0],d=this.points[1];a.set(c-b,d-b,c+b,d+b)}}),m=f.createClass(i,{_calcInitPoints:function(a){this._arc=new l(a),this._points=this._arc.points},_setNewPointPos:function(a,b,c){if(0===a)this.movePoints(b-this._points[0],c-this._points[1]);else{this._points[2*a]=b,this._points[2*a+1]=c,this._arc.raduis=e.diagonal(this._points[0],this._points[1],b,c);var d=e.angle(this._points[0],this._points[1],b,c);this._arc.angles[a-1]=2!==a||d?d:2*Math.PI;var f=3-a;this._points[2*f]=this._points[0]+Math.round(this._arc.raduis*Math.cos(this._arc.angles[f-1])),this._points[2*f+1]=this._points[1]+Math.round(this._arc.raduis*Math.sin(this._arc.angles[f-1]))}},_calcRectByCurveData:function(a){this._arc.calcRect(a)},_drawCurve:function(a){this._arc.draw(a)},_createResultCommand:function(){return new h(this._arc)}},{_arcBuf:new l,drawByRect:function(a,b){this._arcBuf.set(b).draw(a)},calcClearRect:function(a,b){this._arcBuf.set(a).calcRect(b)}});return{constructor:function(){c.call(this),this._editCmd=null,this._parentCmd=null},_mouseHandlers:{dndMouseDown:function(a,b){"root"==a.data.mm.grip?this._apply():this._editCmd.setMoving(!0)},dndStart:function(a){if("root"==a.data.mm.grip){var b=this._paint.tools.options.getData(!0);a.data.activeLayer=this._dom.getActiveLayer(),a.data.tempCanvas=a.data.activeLayer.getTempCanvas(),a.data.tempCtx=a.data.tempCanvas.getContext("2d"),a.data.CmdClass=this._getEditCommandClass(b.curve),a.data.clearRect=new e,a.data.toolOptions=g.shapes.makeLineOptions(b,!1,a.data.activeLayer.rect),g.setOptions(a.data.tempCtx,a.data.toolOptions)}},dndMove:function(a){if("root"==a.data.mm.grip)a.data.clearRect.minSize()>0&&(a.data.tempCtx.clearRect(a.data.clearRect.left,a.data.clearRect.top,a.data.clearRect.width(),a.data.clearRect.height()),a.data.clearRect.zero()),a.data.mm.rect.maxSize(!0)>3&&(a.data.CmdClass.drawByRect(a.data.tempCtx,a.data.mm.rect),this._calcClearRect(a.data));else{var b=a.data.mm.gripNode.__pointNum;this._editCmd.changePoint(b,a.current.nodeX,a.current.nodeY)}},dndStop:function(a){if("root"==a.data.mm.grip){var b=a.data.activeLayer,c=b.getName(),d=this._calcClearRect(a.data);if(d.minSize()>0&&a.data.mm.rect.maxSize(!0)>3){this._editCmd=new a.data.CmdClass;var e=this._paint.tools.options.getData(!0);this._editCmd.setConfig(e,a.data.mm.rect,c),this._parentCmd=new C(this._editCmd),this._runner.historyEventEmitter.un("_historyHandlers",this),this._runner.runToolCommand(c,this._parentCmd),this._runner.historyEventEmitter.on("_historyHandlers",this)}}},dndMouseUp:function(a){"move"==a.data.mm.grip&&this._editCmd.setMoving(!1)}},_calcClearRect:function(a){return a.CmdClass.calcClearRect(a.mm.rect,a.clearRect),a.clearRect.toolResultRect(a.activeLayer,a.toolOptions.lineWidth)},_keyHandlers:{move:function(a){this._parentCmd&&this._parentCmd.done&&this._editCmd.movePoints(a.direction.dx,a.direction.dy,700)},escape:function(a){this._parentCmd&&this._parentCmd.done&&this._runner.history.undo()},enter:function(a){this._apply()}},_toolOptionsHandlers:{set:function(){this._editCmd&&this._paint.tools.options.get("curveApplyOptions")&&this._editCmd.changeOptions()}},_historyHandlers:{redoclear:function(){this._endEdit()},clear:function(){this._endEdit()},running:function(){this._apply()}},_getEditCommandClass:function(a){return/^bezier/.test(a)?k:"arc"===a?m:k},_endEdit:function(){this._editCmd&&(this._editCmd.done&&this._apply(),this._editCmd=this._parentCmd=null)},_apply:function(){this._editCmd&&(this._parentCmd.replaceInnerCommand(this._editCmd.createResultCommand()),this._editCmd=this._parentCmd=null)},_begin:function(){this._mouseMgr.setMode(this._mouseMgr.MODE_RECT,{useActiveLayer:!0,shiftRootResizeType:e.RT_R8}),this._runner.historyEventEmitter.on("_historyHandlers",this)},_end:function(){this._runner.historyEventEmitter.un("_historyHandlers",this),this._apply()}}}),K=f.createClass(G,function(a,b){return{constructor:function(){b.call(this),this._imageDataMap={}},_mouseHandlers:{mousedown:function(a){var b=this._dom.getActiveLayer();if(b.rect.hasPoint(a.start.nodeX,a.start.nodeY)){objName=b.getName();var c=this._imageDataMap[objName];c||(this._imageDataMap[objName]=c=b.getImageData());var d=this._paint.tools.options.getData(!0),e=this._paint.tools.getColor(),f="y"===d.fillAlpha.charAt(1),g="y"===d.fillAlpha.charAt(3),h=c.floodFill(a.start.nodeX-b.rect.left,a.start.nodeY-b.rect.top,e,f,g);if(h){var i,j=b.getCanvas().getContext("2d");i=c.slice(j,h);var k=new E(i,h.left,h.top);this._runner.historyEventEmitter.un("_historyHandlers",this),this._runner.runToolCommand(objName,k.setConfig(objName,h,null)),this._runner.historyEventEmitter.on("_historyHandlers",this)}}}},_historyHandlers:{change:function(){this._imageDataMap={}}},_begin:function(){this._mouseMgr.setMode(this._mouseMgr.MODE_POINT,{}),this._imageDataMap={},this._runner.historyEventEmitter.on("_historyHandlers",this)},_end:function(){this._imageDataMap={},this._runner.historyEventEmitter.un("_historyHandlers",this)}}}),L=f.createClass(G,function(a,b){function c(a){var b=Math.round(a.toolOptions.lineWidth/1.414+2),c=a.activeLayer;return h.set(a.mm.rect).normalize().expand(b).clip(i.set(c.rect).moveTo(0,0))}var d=f.createClass(D,{constructor:function(a){this._lineRect=a},_apply:function(a){g.shapes.drawLine(a,this._lineRect)}}),h=new e,i=new e;return{constructor:function(){b.call(this)},_mouseHandlers:{dndStart:function(a){this._dom.getSelection().hide();var b=this._paint.tools.options.getData(!0);a.data.eraser=g.shapes.isEraser(b.drawLine),a.data.activeLayer=this._dom.getActiveLayer(),a.data.tempCanvas=a.data.activeLayer.getTempCanvas(a.data.eraser),a.data.tempCtx=a.data.tempCanvas.getContext("2d"),a.data.toolOptions=g.shapes.makeLineOptions(b,!0,a.data.activeLayer.rect),g.setOptions(a.data.tempCtx,a.data.toolOptions)},dndMove:function(a){h.minSize()>0&&(a.data.eraser?a.data.activeLayer.restoreTempCanvasImage(h):a.data.tempCtx.clearRect(h.left,h.top,h.width(),h.height()),h.zero()),a.data.mm.rect.maxSize(!0)&&(g.shapes.drawLine(a.data.tempCtx,a.data.mm.rect),c(a.data))},dndStop:function(a){var b=a.data.activeLayer,e=b.getName(),f=c(a.data).clone();if(f.minSize()>0&&a.data.mm.rect.maxSize(!0)){var g=new d(a.data.mm.rect);this._runner.runToolCommand(e,g.setConfig(e,f,a.data.toolOptions))}b.hideTempCanvas()}},_begin:function(){this._mouseMgr.setMode(this._mouseMgr.MODE_RECT,{useActiveLayer:!0,shiftRootResizeType:e.RT_R8})},_end:function(){}}}),M=f.createClass(c,{constructor:function(a,b,d,e){c.call(this),this._config=a,this._paint=b,this._runner=d,this._keyManager=e,this.options=new i((!1),V.toolOptionsConfig),this.options.on("_optionsHandlers",this),this._tool=null,this._toolName="",this._toolMap={},this._rgba={},this._updateColor("color"),this._updateColor("fillColor")},setDOM:function(a,b){this._dom||(this._dom=a,this._mouseManager=b,this._addTool("crop",new I),this._addTool("select",new P),this._addTool("bgresize",new H),this._addTool("pen",new N((!1))),this._addTool("eraser",new N((!0))),this._addTool("line",new L),this._addTool("rect",new Q("rect")),this._addTool("roundrect",new Q("roundrect")),this._addTool("ellipse",new Q("ellipse")),this._addTool("fill",new K),this._addTool("picker",new O),this._addTool("curve",new J),this._addTool("text",new R))},destroy:function(){this.un(),this.options.un(),this._end();for(var a in this._toolMap)this._toolMap.hasOwnProperty(a)&&this._toolMap[a]&&this._toolMap[a].destroy();this._toolMap=null,this._mouseManager=null,this._keyManager=null,this._dom=null,this._config=null,this._paint=null,this._runner=null},_addTool:function(a,b){a&&b&&!this._toolMap[a]&&(this._toolMap[a]=b,b.init(this._config,this._paint,this._runner,this._dom,this._mouseManager,this._keyManager))},_updateColor:function(a){this._rgba[a]=g.color.getRGBA(this.options.get(a))},_optionsHandlers:{set:function(a){"color"!==a.name&&"fillColor"!==a.name||this._updateColor(a.name)}},getColor:function(){return this._rgba.color},getFillColor:function(){return this._rgba.fillColor},current:function(a){if(!this._paint)return this;if(void 0===a)return this._toolName;var b;return a?"string"==typeof a&&this._toolMap.hasOwnProperty(a)&&this._toolName!==a?(b=this._endTool(),this._paint.filters.cancel(),this._toolName=a,this._tool=this._toolMap[a],this._tool.begin(),this.emit("change",{name:a,oldName:b}),this):this:(this._toolName&&(b=this._endTool(),this.emit("change",{name:"",oldName:b})),this)},_endTool:function(){if(this._tool){var a=this._toolName;return this._tool.end(),this._toolName="",this._tool=null,this.emit("end",a),a}return this._toolName}}),N=f.createClass(G,function(a,b){var c=f.createClass(D,{constructor:function(a,b,c){this._path=a,this._lineWidth=b,this._penForm=c},_apply:function(a){g.shapes.drawPath(a,this._path,this._lineWidth,this._penForm)}}),d=new e;return{constructor:function(a){
b.call(this),this._eraser=a,a||(this._cursorHandlers=this._cursorHandlersForPen)},_mouseHandlers:{dndMouseDown:function(a,b,c){this._dom.getSelection().hide();var d=this._paint.tools.options.getData(!0),e=this._eraser;a.data.activeLayer=this._dom.getActiveLayer(),a.data.tempCanvas=a.data.activeLayer.getTempCanvas(e),a.data.tempCtx=a.data.tempCanvas.getContext("2d"),a.data.toolOptions=g.shapes.makePenOptions(d,null,a.data.activeLayer.rect,e),a.data.lineWidth=d.lineWidth||1,a.data.penForm=d.penForm;var f=a.data.toolOptions;if(!e){var h=g.color.extactAlpha(d.color);h.alpha<1&&(a.data.tempCanvas.style.opacity=h.alpha,f=g.shapes.makePenOptions(d,h.color,a.data.activeLayer.rect,e))}g.setOptions(a.data.tempCtx,f),g.shapes.drawPath(a.data.tempCtx,a.data.mm.path,a.data.lineWidth,a.data.penForm)},dndMove:function(a){g.shapes.drawPath(a.data.tempCtx,a.data.mm.lastLine,a.data.lineWidth,a.data.penForm)},dndMouseUp:function(a){var b=a.data.activeLayer,e=b.getName(),f=Math.round(a.data.lineWidth/2+2),h=a.data.mm.boundingRect.expand(f).clip(d.set(b.rect).moveTo(0,0));if(h.minSize()>0){g.shapes.compressPath(a.data.mm.path);var i=new c(a.data.mm.path,a.data.lineWidth,a.data.penForm);this._runner.runToolCommand(e,i.setConfig(e,h,a.data.toolOptions))}b.hideTempCanvas()}},_cursorHandlersForPen:{mousemove:function(a,b){var c=this._paint.tools.options.getData(!0);if(c.lineWidth>=3&&c.drawPattern){var d=c.lineWidth,e=Math.floor(d/2);b.setStyle("backgroundPosition",e-a.x+"px "+(e-a.y)+"px")}}},_toolOptionsHandlers:{set:function(){this._updateCursor()}},_updateCursor:function(){var a=this._paint.tools.options.getData(!0);if(a.lineWidth<3)this._dom.cursor.enable(!1);else{var b=a.lineWidth,c=Math.floor(b/2),d=this._eraser,e=d?"rgba(255, 255, 255, 0.85)":a.color;!d&&a.drawPattern&&(e="transparent url("+g.patterns.getPatternUrl(a.drawPattern,a.color)+") 0 0 repeat"),this._dom.cursor.setSize(b,b).setHotPoint(c,c).mode(a.penForm+"-"+(d?"eraser":"pen")).setBG(e).enable(!0)}},_begin:function(){this._mouseMgr.setMode(this._mouseMgr.MODE_PATH,{useActiveLayer:!0}),this._dom.getSelection().hide(),this._dom.cursor.moveInAreaOnly(!1),this._updateCursor()},_end:function(){this._dom.cursor.enable(!1).mode("none")}}}),O=function(){return f.createClass(G,{constructor:function(){G.call(this)},_getColor:function(a,b){return this._dom.getPixelColor(a,b)},_mouseHandlers:{mousedown:function(a){var b=this._paint.tools.options.get("picker"),c=this._getColor(a.start.nodeX,a.start.nodeY);c&&this._paint.tools.options.set(b,g.color.colorStr(c))}},_begin:function(){this._mouseMgr.setMode(this._mouseMgr.MODE_POINT,{areaOnly:!0})},_end:function(){}})}(),P=f.createClass(G,{constructor:function(){G.call(this)},_mouseHandlers:{dndMouseDown:function(a,b,c){this._dom.getSelection().mode("select").hide(),this._runner.history.beginBatch(),"root"===a.data.mm.grip&&this._runner.removeObject(!0),this._dom.getSelection().moving(!0),this._dom.getObject("frame").moving(!0)},dndStart:function(a){a.start.cmdKey&&a.data.mm.object&&"frame"===a.data.mm.object.getType()&&this._runner.drawObject()},dndMove:function(a){var b=a.data.mm.object||this._dom.getSelection();b.show(a.data.mm.rect)},dndStop:function(a){a.data.mm.object?this._runner.moveObject("frame",a.data.mm.rect.saveProportions(),a.data.mm.startRect,!0):this._runner.createObject(a.data.mm.rect,!1)},dndMouseUp:function(a){this._runner.history.endBatch(),this._dom.getSelection().moving(!1),this._dom.getObject("frame").moving(!1)}},_keyHandlers:{move:function(a){var b=this._dom.getObject("frame",!0);if(b){var c=b.rect.clone(!0);b.move(a.direction.dx,a.direction.dy,800);var d=Math.round((new Date).valueOf()/4e3);this._runner.moveObject("frame",b.rect,c,!0,"kbfmove"+d)}},del:function(a){this._runner.removeObject(!1)},enter:function(a){this._runner.removeObject(!0)},requestCopyData:function(a,b,c){var d=this._dom.getObject("frame",!0);if(d){var e=d.getResizedCanvas();if(e){var f=h.customImageClipboard.put(e);c(f)}}}},_minSize:{width:1,height:1},_begin:function(){this._mouseMgr.setMode(this._mouseMgr.MODE_RECT,{resizeResizeType:e.RT_AVG,shiftRootResizeType:e.RT_AVG,resizePositiveOnly:!0,minSize:this._minSize,rootClip:this._dom.getBG().rect}),this._dom.getSelection().hide().mode("select"),this._dom.getObject("frame").enableDND(!0)},_end:function(){this._dom.getObject("frame").enableDND(!1)}}),Q=f.createClass(G,function(a,b){function c(a){var b=Math.round(a.toolOptions.lineWidth/1.414+2),c=a.activeLayer;return h.set(a.mm.rect).normalize().expand(b).clip(i.set(c.rect).moveTo(0,0))}var d=f.createClass(D,{constructor:function(a,b,c,d){this._shape=a,this._shapeRect=b,this._drawShape=c,this._shapeOptions=d},_apply:function(a){g.shapes.drawShape(a,this._shape,this._shapeRect,this._drawShape,this._shapeOptions)}}),h=new e,i=new e;return{constructor:function(a){b.call(this),this._shape=a},_mouseHandlers:{dndStart:function(a){this._dom.getSelection().hide();var b=this._paint.tools.options.getData(!0);a.data.eraser=g.shapes.isEraser(b.drawShape),a.data.drawShape=b.drawShape,a.data.activeLayer=this._dom.getActiveLayer(),a.data.tempCanvas=a.data.activeLayer.getTempCanvas(a.data.eraser),a.data.tempCtx=a.data.tempCanvas.getContext("2d"),a.data.shapeOptions={rectRadius:b.rectRadius},a.data.toolOptions=g.shapes.makeShapeOptions(b,this._shape,a.data.activeLayer.rect),g.setOptions(a.data.tempCtx,a.data.toolOptions)},dndMove:function(a){h.minSize()>0&&(a.data.eraser?a.data.activeLayer.restoreTempCanvasImage(h):a.data.tempCtx.clearRect(h.left,h.top,h.width(),h.height()),h.zero()),a.data.mm.rect.minSize(!0)&&(h.set(a.data.mm.rect).normalize(),g.shapes.drawShape(a.data.tempCtx,this._shape,h,a.data.drawShape,a.data.shapeOptions),c(a.data))},dndStop:function(a){var b=a.data.activeLayer,e=b.getName(),f=c(a.data).clone();if(f.minSize()>0&&a.data.mm.rect.minSize(!0)){var g=new d(this._shape,a.data.mm.rect.normalize(),a.data.drawShape,a.data.shapeOptions);this._runner.runToolCommand(e,g.setConfig(e,f,a.data.toolOptions))}b.hideTempCanvas()}},_begin:function(){this._mouseMgr.setMode(this._mouseMgr.MODE_RECT,{useActiveLayer:!0,shiftRootResizeType:e.RT_AVG})},_end:function(){}}}),R=f.createClass(G,function(a,b){var c=f.createClass(D,{constructor:function(a,b,c){this._strings=a,this._lineHeight=b,this._pos=c},_apply:function(a){g.text.drawText(a,this._strings,this._pos,this._lineHeight)}}),d=new e;return{constructor:function(){b.call(this)},_mouseHandlers:{dndMouseDown:function(a,b,c){"move"===a.data.mm.grip&&a.data.mm.object.moving(!0)},dndMove:function(a){this._dom.getObject("text").show(a.data.mm.rect)},dndMouseUp:function(a){"move"===a.data.mm.grip&&a.data.mm.object.moving(!1)},click:function(a){var b=this._dom.getObject("text");if(b.visible())b.getText()||b.hide();else{var c=this._paint.tools.options.getData(!0);b.showAt(a.areaX,a.areaY),b.setFont(c),b.mode(b.MODE_EDIT)}}},_keyHandlers:{move:function(a){this._dom.getObject("text").move(a.direction.dx,a.direction.dy,800)},enter:function(a){this._apply(this._dom.getObject("text"))},tab:function(a){var b=this._dom.getObject("text",!0);b&&b.mode(b.MODE_EDIT)},escape:function(){this._dom.getObject("text").hide()},del:function(a){this._dom.getObject("text").hide()}},_tiHandlers:{applytext:function(a,b){this._apply(b)},tab:function(){this._keyMgr.focus()},escape:function(a,b){this._keyMgr.focus(),b.hide()}},_toolOptionsHandlers:{set:function(a){var b=this._dom.getObject("text");("color"===a.name||/^font/.test(a.name))&&this._setFont(b)}},_setFont:function(a){var b=this._paint.tools.options.getData(!0);a.setFont(b)},_apply:function(a){if(a&&a.visible()){var b=a.rect.clone(),e=a.getStrings(),f=this._dom.getActiveLayer();if(a.getText()&&e&&e.length&&b.isIntersect(f.rect)){var g=f.getName();b.move(-f.rect.left,-f.rect.top);var h=new c(e,a.lineHeight,b.point());b.clip(f.rect.clone(d).moveTo(0,0)),this._runner.runToolCommand(g,h.setConfig(g,b,a.ctxOptions))}a.hide()}},_begin:function(){this._mouseMgr.setMode(this._mouseMgr.MODE_RECT,{gripRoot:!1}),this._dom.getSelection().hide(),this._dom.getObject("text").on("_tiHandlers",this)},_end:function(){var a=this._dom.getObject("text");a.un("_tiHandlers",this),this._apply(a)}}}),S=f.createClass(null,{constructor:function(){this._started=!1,this._valueCount=this._ranges.length,this._values=[],this._canRedraw=!1},_ranges:[],init:function(a,b,c,d,e){this._config=a,this._manager=b,this._filterRunner=c,this._runner=d,this._dom=e,this._init()},destroy:function(){this.cancel(),this._destroy(),this._config=null,this._manager=null,this._runner=null,this._dom=null,this._filterRunner=null},begin:function(){if(!this._started){this._started=!0;for(var a=0;a<this._valueCount;++a)this._values[a]=this._ranges[a][1];this._begin()}},end:function(){this._started&&(this._started=!1,this._end(),this._values=[],this._canRedraw=!1)},redraw:function(){this._canRedraw=!0,this._redraw()},valueCount:function(){return this._valueCount},minValue:function(a){return a<this._valueCount?this._ranges[a][0]:null},maxValue:function(a){return a<this._valueCount?this._ranges[a][2]:null},getValue:function(a){return a<this._valueCount?this._values[a]:null},setValue:function(a,b){a<this._valueCount&&"number"==typeof b&&(b=f.between(this._ranges[a][0],Math.round(b),this._ranges[a][2]),b!==this._values[a]&&(this._values[a]=b,this._redraw()))},_redraw:function(){if(this._canRedraw){var a=this._filterRunner.getSourceImageData(),b=this._filterRunner.getDestinationImageData();this._calcImageData(a,b,a.width,a.height,a.data.length),this._filterRunner.preview()}},_calcImageData:function(a,b,c,d,e){},_init:function(){},_destroy:function(){},_begin:function(){},_end:function(){}});convolvingFilters={convolving:function(a,b,c,d,e){for(var a=a.data,b=b.data,f=4*c,g=0;g<d;++g)for(var h=g===d-1,i=0;i<c;++i){var j=4*(g*c+i);if(b[j+3]=a[j+3],b[j+3]>1){for(var k=i===c-1,l=0,m=0,n=0,o=-1,p=-f;p<=f;p+=f)for(var q=-4;q<=4;q+=4){var r=j+(!g&&p<0||h&&p>0?0:p)+(!i&&q<0||k&&q>0?0:q),s=e[++o];l+=a[r]*s,m+=a[r+1]*s,n+=a[r+2]*s}b[j]=l,b[j+1]=m,b[j+2]=n}}}},convolvingFilters.Sharpen=f.createClass(S,{constructor:function(){S.call(this),this._matrix=[0,0,0,0,1,0,0,0,0]},_levels:[0,.2,.5,1,2,3],_ranges:[[0,0,5]],_calcImageData:function(a,b,c,d,e){var f=this._levels[this.getValue(0)];f?(this._matrix[1]=this._matrix[3]=this._matrix[5]=this._matrix[7]=-f,this._matrix[4]=4*f+1,convolvingFilters.convolving(a,b,c,d,this._matrix)):g.imageData.copy(a,b)}}),convolvingFilters.Relief=f.createClass(S,{constructor:function(){S.call(this),this._matrix=[0,0,0,0,1,0,0,0,0]},_ranges:[[0,0,10],[0,0,24]],_calcImageData:function(a,b,c,d,e){var f=this.getValue(0),h=Math.PI*this.getValue(1)/12;if(f){for(var i=0,j=Math.PI/4,k=0;k<9;++k)4!=k&&(this._matrix[k]=-f*Math.cos(h-i),i+=j);convolvingFilters.convolving(a,b,c,d,this._matrix)}else g.imageData.copy(a,b)}});var T=f.createClass(c,{constructor:function(a,b,d){c.call(this),this._filterRunner=null,this._config=a,this._runner=d,this._paint=b,this._lastPaintTool=null,this._filter=null,this._filterName="",this._filterMap={}},setDOM:function(a){this._dom||(this._dom=a,this._filterRunner=new T.Runner(a,this._runner),this._addFilter("brightness",new U.Brightness),this._addFilter("contrast",new U.Contrast),this._addFilter("grayscale",new U.Grayscale),this._addFilter("sepia",new U.Sepia),this._addFilter("invert",new U.Invert),this._addFilter("threshold",new U.Threshold),this._addFilter("saturation",new U.Saturation),this._addFilter("vibrance",new U.Vibrance),this._addFilter("sharpen",new convolvingFilters.Sharpen),this._addFilter("relief",new convolvingFilters.Relief),this._runner.historyEventEmitter.on("_historyHandlers",this))},destroy:function(){this.un(),this.cancel();for(var a in this._filterMap)this._filterMap.hasOwnProperty(a)&&this._filterMap[a]&&this._filterMap[a].destroy();this._filterRunner&&this._filterRunner.destroy(),this._filterMap=null,this._dom=null,this._filterRunner=null,this._config=null,this._paint=null,this._runner=null},_addFilter:function(a,b){a&&b&&!this._filterMap[a]&&(this._filterMap[a]=b,b.init(this._config,this,this._filterRunner,this._runner,this._dom))},_callFilterMethod:function(a,b,c){return this._filter?this._filter[a](b,c):null},current:function(a){if(!this._paint)return this;if(void 0===a)return this._filterName;var b=this._filterName;return a?"string"==typeof a&&this._filterMap.hasOwnProperty(a)&&this._filterName!==a?(this._cancel(a),this._paint.tools.current(null),this._filterName=a,this._filter=this._filterMap[a],this._filter.begin(),this.emit("change",{name:a,oldName:b}),this._filter.redraw(),this):this:(this._filter&&(this._cancel(null),this.emit("change",{name:"",oldName:b})),this)},valueCount:function(){return this._callFilterMethod("valueCount")||0},minValue:function(a){return this._callFilterMethod("minValue",a)},maxValue:function(a){return this._callFilterMethod("maxValue",a)},getValue:function(a){return this._callFilterMethod("getValue",a)},setValue:function(a,b){this._callFilterMethod("setValue",a,b)},apply:function(){if(this._filter){this._applying=!0,this._filterRunner.apply(),this._applying=!1;var a=this._filterName;this._end(null),this.emit("change",{name:"",oldName:a})}},cancel:function(){this.current(null)},_cancel:function(a){this._filter&&(this._filterRunner.end(),this._end(a))},_end:function(a){this._filter.end();var b=this._filterName;this._filter=null,this._filterName="",this.emit("end",b)},_cancelFromHistory:function(){this._applying||(this.cancel(),this._filterRunner.clear())},_historyHandlers:{changing:function(){this._cancelFromHistory()},running:function(){this._cancelFromHistory()}}});T.Runner=f.createClass(null,{constructor:function(a,b){this._dom=a,this._runner=b,this._srcData=null,this._destData=null},destroy:function(){this._dom=null,this._runner=runner,this.clear()},getSourceImageData:function(){if(!this._srcData){var a=this._dom.getActiveLayer(),b=a.getResizedCanvas().getContext("2d");this._srcData=b.getImageData(0,0,a.rect.width(),a.rect.height())}return this._srcData},getDestinationImageData:function(){if(!this._destData){var a=this._dom.getActiveLayer(),b=a.getResizedCanvas().getContext("2d");this._destData=b.createImageData(a.rect.width(),a.rect.height())}return this._destData},preview:function(){var a=this._dom.getActiveLayer(),b=a.getTempContext();b.putImageData(this._destData,0,0),a.hideCanvas()},apply:function(){if(this._destData){var a=this._dom.getActiveLayer(),b=a.getName(),c=new E(this._destData,0,0);this._srcData=this._destData,this._destData=null,this._runner.runToolCommand(b,c.setConfig(b,a.rect.clone(),null))}this.end()},end:function(){this._dom.getActiveLayer().hideTempCanvas()},clear:function(){this._srcData=null,this._destData=null}});var U={};U.Brightness=f.createClass(S,{constructor:function(){S.call(this)},_ranges:[[-100,0,100]],_calcImageData:function(a,b,c,d,e){var f=2*this.getValue(0);a=a.data,b=b.data;for(var g=0;g<e;g+=4)a[g+3]>1&&(b[g]=a[g]+f,b[g+1]=a[g+1]+f,b[g+2]=a[g+2]+f),b[g+3]=a[g+3]}}),U.Invert=f.createClass(S,{constructor:function(){S.call(this)},_ranges:[[0,0,100]],_calcImageData:function(a,b,c,d,e){var f=this.getValue(0)/this.maxValue(0),g=1-f;a=a.data,b=b.data;for(var h=0;h<e;h+=4)a[h+3]>1&&(b[h]=f*(255-a[h])+g*a[h],b[h+1]=f*(255-a[h+1])+g*a[h+1],b[h+2]=f*(255-a[h+2])+g*a[h+2]),b[h+3]=a[h+3]}}),U.Grayscale=f.createClass(S,{constructor:function(){S.call(this)},_ranges:[[0,0,100]],_calcImageData:function(a,b,c,d,e){var f=this.getValue(0)/this.maxValue(0),g=1-f;a=a.data,b=b.data;for(var h=0;h<e;h+=4){if(a[h+3]>1){var i=a[h],j=a[h+1],k=a[h+2],l=f*(.2126*i+.7152*j+.0722*k);b[h]=l+g*i,b[h+1]=l+g*j,b[h+2]=l+g*k}b[h+3]=a[h+3]}}}),U.Sepia=f.createClass(S,{constructor:function(){S.call(this)},_ranges:[[0,0,100]],_calcImageData:function(a,b,c,d,e){var f=this.getValue(0)/this.maxValue(0),g=1-f;a=a.data,b=b.data;for(var h=0;h<e;h+=4)if(b[h+3]=a[h+3],a[h+3]>1){var i=a[h],j=a[h+1],k=a[h+2];b[h]=f*(.393*i+.769*j+.189*k)+g*i,b[h+1]=f*(.349*i+.686*j+.168*k)+g*j,b[h+2]=f*(.272*i+.534*j+.131*k)+g*k}}}),U.Threshold=f.createClass(S,{constructor:function(){S.call(this)},_ranges:[[0,40,255],[0,60,255],[0,90,255],[0,140,255]],_calcImageData:function(a,b,c,d,e){a=a.data,b=b.data;for(var f=this.getValue(0),g=this.getValue(1),h=this.getValue(2),i=this.getValue(3),j=0;j<e;j+=4){if(a[j+3]>1){var k=.2126*a[j]+.7152*a[j+1]+.0722*a[j+2];k=k<f?0:k<g?64:k<h?128:k<i?192:255,b[j]=k,b[j+1]=k,b[j+2]=k}b[j+3]=a[j+3]}}}),U.Saturation=f.createClass(S,{constructor:function(){S.call(this)},_ranges:[[-100,0,100]],_calcImageData:function(a,b,c,d,e){a=a.data,b=b.data;for(var f=-this.getValue(0)/(this.getValue(0)<0?100:25),g=0;g<e;g+=4)if(b[g+3]=a[g+3],a[g+3]>1){var h=a[g],i=a[g+1],j=a[g+2],k=Math.max(h,i,j);b[g]=h+(k-h)*f,b[g+1]=i+(k-i)*f,b[g+2]=j+(k-j)*f}}}),U.Vibrance=f.createClass(S,{constructor:function(){S.call(this)},_ranges:[[-100,0,100]],_calcImageData:function(a,b,c,d,e){a=a.data,b=b.data;for(var f=-this.getValue(0)/(this.getValue(0)<0?100:25),g=0;g<e;g+=4)if(b[g+3]=a[g+3],a[g+3]>1){var h=a[g],i=a[g+1],j=a[g+2],k=Math.max(h,i,j),l=(h+i+j)/3,m=2*Math.abs(k-l)/255*f;b[g]=h+(k-h)*m,b[g+1]=i+(k-i)*m,b[g+2]=j+(k-j)*m}}}),U.Contrast=f.createClass(S,{constructor:function(){S.call(this)},_ranges:[[-100,0,100]],_calcImageData:function(a,b,c,d,e){a=a.data,b=b.data;for(var f=Math.pow((this.getValue(0)+100)/100,2),g=0;g<e;g+=4)b[g+3]=a[g+3],a[g+3]>1&&(b[g]=255*((a[g]/255-.5)*f+.5),b[g+1]=255*((a[g+1]/255-.5)*f+.5),b[g+2]=255*((a[g+2]/255-.5)*f+.5))}});var V={defConfig:{historyLimit:6,width:500,height:400,minWidth:8,minHeight:8,margin:16,openDDFiles:!1,bgTileSize:8,bgTileColor1:"#c9c9c9",bgTileColor2:"#fefefe"},toolOptionsConfig:{color:{defValue:"#000000",check:g.color.checkColor,translate:g.color.format},fillColor:{defValue:"#dddddd",check:g.color.checkColor,translate:g.color.format},penForm:{defValue:"round",check:["round","square"]},lineCap:{defValue:"round",check:["round","butt","square"]},lineJoin:{defValue:"round",check:["round","miter","bevel"]},lineWidth:{defValue:1,check:f.checkNumber(1,100,!0)},rectRadius:{defValue:8,check:f.checkNumber(1,100,!0)},drawPattern:{defValue:"",check:g.patterns.checkName},fillType:{defValue:"replace",check:["replace"]},fillAlpha:{defValue:"cyry",check:["cyry","cnrn","cyrn","cnry"]},picker:{defValue:"color",check:["color","fillColor"]},drawLine:{defValue:"stroke",check:["stroke","erase","parterase"]},drawShape:{defValue:"both",check:["stroke","fill","both","erase","parterase"]},curve:{defValue:"bezier3",check:["line","bezier2","bezier3","arc"]},curveApplyOptions:{defValue:!0,check:"boolean"},fontBold:{defValue:!1,check:"boolean"},fontItalic:{defValue:!1,check:"boolean"},fontSize:{defValue:16,check:f.checkNumber(5,100,!0)},fontFamily:{defValue:"sans-serif"}},constValues:{minWidth:1,minHeight:1}},W=f.createClass(c,function(a,b){function c(){}return{constructor:function(a,c){b.call(this);var d=this._config=f.copy({},V.defConfig,c);d.minWidth=Math.max(d.minWidth,V.constValues.minWidth),d.minHeight=Math.max(d.minHeight,V.constValues.minHeight),d.width=f.between(d.minWidth,d.width,null),d.height=f.between(d.minHeight,d.height,null),d._minSize={width:d.minWidth,height:d.minHeight},d._minRect=new e(d._minSize),this._dom=null,this._keyManager=new o(d),this._keyManager.on("_eventsKeyBoard",this),this._runner=new F(d,this),this.tools=new M(d,this,this._runner,this._keyManager),this.filters=new T(d,this,this._runner),this.history=this._runner.getHistory(),this.renderTo(a)},renderTo:function(a){if(!this._dom&&a&&a.tagName&&a.parentNode){var b=this._config;this._dom=new n(a,b),this._dom.on("_eventsDOM",this),this._mouseManager=new p(b,this._dom,this._dom.root),this._mouseManager.on("_eventsMouse",this),this._runner.setDOM(this._dom),this.tools.setDOM(this._dom,this._mouseManager),this.filters.setDOM(this._dom)}},created:function(){return!!this._dom},destroy:function(){this.un(),this.history.un(),this._mouseManager.destroy(),this._keyManager.destroy(),this._runner.destroy(),this.tools.destroy(),this.filters.destroy(),this._dom.destroy(),this.tools=null,this.filters=null,this.history=null,this._dom=null,this._mouseManager=null,this._keyManager=null,this._runner=null},_eventsDOM:{resize:function(){this.emit("resize")}},_eventsMouse:{keyManagerFocus:function(){this._keyManager.focus()},dropImage:function(a){this._insertImageFromEvent(a)}},_eventsKeyBoard:{pasteImage:function(a){this._insertImageFromEvent(a)},selectAll:function(a){this.createObject("all")},undo:function(a){this.history.undo()},redo:function(a){this.history.redo()}},_insertImageFromEvent:function(a){return a.img?void(a.fileName&&this._config.openDDFiles?this.openImage(a.img):this.insertImage(a.img,a.point)):void(a.url&&this.insertResource(a.url,a.point))},resize:function(a){a&&this.created()&&(a=f.sizeBetween(this._config._minSize,a),a.width==this.width()&&a.height==this.height()||(this._runner.moveObject("bg",new e(a)),this._keyManager.focus()))},focus:function(){this._keyManager.focus()},crop:function(a){this.created()&&(this._runner.crop(a),this._keyManager.focus())},createObject:function(a,b){this.created()&&(this.tools.current("select"),this._runner.createObject(a,b),this._keyManager.focus())},insertImage:function(a,b){if(this.created()&&j.isGoodImage(a)){var c=j.getImageSize(a);c.width&&c.height&&(this.tools.current("select"),this._runner.insertImage(a,b,c),this._keyManager.focus())}},removeObject:function(a){this.created()&&(this._runner.removeObject(a),this._keyManager.focus())},newImage:function(a){this.created()&&(a=a||{width:this._config.width,height:this._config.height},a=f.sizeBetween(this._config._minSize,a),this._runner.newImage(a),this._keyManager.focus())},openImage:function(a){if(this.created()&&j.isGoodImage(a)){var b=j.getImageSize(a);b.width&&b.height&&(b=f.sizeBetween(this._config._minSize,b),this._runner.newImage(b,a))}},_getProxyUrl:function(a){return this.emit("getProxyUrl",a,!0)||a},_getImage:function(a,b,d,e){if(this.created())return b=b||c,a?void h.getImage(a,{ctx:this,getProxyUrl:this._getProxyUrl,useCredentials:!1},function(a){a.img&&e.call(this,a.img),b.call(d,a.error,this)},this):void b.call(d,null,this)},insertResource:function(a,b,c,d){this._getImage(a,c,d,function(a){this.insertImage(a,b)})},openResource:function(a,b,c){this._getImage(a,b,c,this.openImage)},hideSelection:function(){this.created()&&this._dom.getSelection().hide()},rotate:function(a,b){if(this.created()){this.hideSelection();var c=this._dom.getBG(),d=b?c:this._dom.getActiveLayer(),e=null,f=d.getCanvas(),h=j.getImageSize(f);if("90"===a||"270"===a){var i=d.rect.left||d.rect.top;e=d.rect.clone(!0).rotate90(i);var k=h.width;h.width=h.height,h.height=k}var l=j.createCanvas(h);g.rotate.rotateOrto(f,l.getContext("2d"),a),this._runner.replaceCanvas(d.getName(),l,e)}},width:function(a){return this.created()?(a?this._dom:this._dom.getBG()).rect.width():0},height:function(a){return this.created()?(a?this._dom:this._dom.getBG()).rect.height():0},offsetWidth:function(a){return this.created()?this._dom.rect.width()+(a?2*this._config.padding:0):0},offsetHeight:function(a){return this.created()?this._dom.rect.height()+(a?2*this._config.padding:0):0},getRootNode:function(){return this.created()?this._dom.root:null},_getCanvasForSave:function(){var a=this._dom.getBG().getResizedCanvas(),b=this._dom.getObject("frame",!0);if(!b)return a;a=j.createCanvas(a);var c=b.getResizedCanvas();return a.getContext("2d").drawImage(c,b.rect.left,b.rect.top),a},_getMimeType:function(a){return a&&!/^image/i.test(a)&&(a="image/"+a),a},toDataURL:function(a,b){return this.created()?(a=this._getMimeType(a),this._getCanvasForSave().toDataURL(a,b)):null},toBlob:function(a,b,c){return this.created()?(b=this._getMimeType(b),this._getCanvasForSave().toBlob(a,b,c)):(a&&a(null),null)}}});return{Paint:W,utils:{Rect:e,dnd:b,createClass:f.createClass,color:g.color,patterns:g.patterns,EventEmitter:c}}});